# Oxide WDNS 示例配置文件（支持DNS分流）

# --- HTTP 服务器配置 ---
http_server:
  # 服务器监听地址和端口
  listen_addr: "127.0.0.1:3053"
  # 服务器连接超时时间（秒）
  timeout: 120

  # --- 速率限制配置 ---
  rate_limit:
    # 是否启用速率限制
    enabled: true
    # 每个 IP 地址每秒允许的最大请求数
    per_ip_rate: 100
    # 单个 IP 地址允许的最大并发请求数
    per_ip_concurrent: 10

# --- DNS 解析器配置 ---
dns_resolver:
  # --- 全局/默认上游 DNS 配置 ---
  # 这些设置作为全局默认值，可以被 upstream_groups 中的同名设置覆盖。
  # 如果没有任何路由规则匹配，并且 routing.default_upstream_group 未指定，
  # 则这里的 resolvers 将作为最终的后备选项。
  upstream:
    # 是否启用 DNSSEC 验证
    enable_dnssec: true
    # DNS 查询超时时间（秒）
    query_timeout: 30
    # 默认上游 DNS 解析器列表
    resolvers:
      # Cloudflare DNS (协议: UDP)
      - address: "1.1.1.1:53"
        protocol: "udp"
      # Google DNS (协议: UDP)
      - address: "8.8.8.8:53"
        protocol: "udp"

  # --- HTTP 客户端配置（用于 DoH 等） ---
  http_client:
    # HTTP 客户端请求超时时间（秒）
    timeout: 120

    # --- 连接池配置 ---
    pool:
      # 连接池中空闲连接的最大保持时间（秒）
      idle_timeout: 30
      # 连接池允许的最大空闲连接数
      max_idle_connections: 10

    # --- HTTP 请求相关配置 ---
    request:
      # 发起 HTTP 请求时使用的 User-Agent
      user_agent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/135.0.0.0 Safari/537.36"
      # 用于识别客户端真实 IP 地址的 HTTP 头部字段名列表
      # 按顺序尝试读取，取第一个非空值
      ip_header_names:
        - "X-Forwarded-For"
        - "X-Real-IP"
        - "CF-Connecting-IP"

  # --- DNS 缓存配置 ---
  cache:
    # 是否启用 DNS 缓存
    enabled: true
    # 缓存条目的最大数量
    size: 10000

    # --- 缓存 TTL (Time-To-Live) 配置（单位：秒） ---
    ttl:
      # 缓存记录的最小 TTL
      min: 60
      # 缓存记录的最大 TTL（例如：86400 秒 = 1 天）
      max: 86400
      # 否定缓存（查询失败记录）的 TTL（例如：300 秒 = 5 分钟）
      negative: 300

  # --- DNS 分流路由配置 ---
  routing:
    # 是否启用 DNS 分流功能
    enabled: true

    # --- 定义上游 DNS 服务器组 ---
    # 每个组可以包含多个解析器，并可独立配置 DNSSEC 和超时。
    # 如果组内未配置某项，则继承全局 'upstream' 中的默认值。
    upstream_groups:
      # 组名：alidns_doh
      - name: "alidns_doh"
        # 覆盖全局设置：此组禁用 DNSSEC
        enable_dnssec: false
        # 覆盖全局设置：此组使用 15 秒超时
        query_timeout: 15
        # 此组的解析器列表
        resolvers:
          # Alidns (协议: DoH)
          - address: "https://dns.alidns.com/dns-query"
            protocol: "doh"
          # DNSPod Public DNS (协议: DoH)
          - address: "https://doh.pub/dns-query"
            protocol: "doh"

      # 组名：googledns_doh
      - name: "googledns_doh"
        # 此组未指定 enable_dnssec 和 query_timeout,
        # 将继承全局 upstream 的设置 (true 和 30 秒)
        resolvers:
          # Google DNS (协议: DoH)
          - address: "https://dns.google/dns-query"
            protocol: "doh"
          # Google DNS (协议: UDP)
          - address: "8.8.8.8:53"
            protocol: "udp"

    # --- 定义分流规则列表 ---
    # 规则按顺序进行匹配，第一个匹配到的规则生效。
    rules:
      # 规则 1: 将精确匹配的域名列表路由到 'alidns_doh' 组
      - match:
          # 匹配类型：精确匹配
          type: exact
          # 匹配值列表
          values: ["bilibili.com", "qq.com", "taobao.com"]
        # 目标上游组
        upstream_group: "alidns_doh"

      # 规则 2: 将匹配正则表达式的域名路由到 'googledns_doh' 组
      - match:
          # 匹配类型：正则表达式匹配
          type: regex
          # 匹配的正则表达式列表
          values:
            - "^(.*\\.)?(google|youtube|gstatic)\\.com$"
            - "^(.*\\.)?openai\\.com$"
        # 目标上游组
        upstream_group: "googledns_doh"

      # 规则 3: 将通配符匹配的域名路由到 'googledns_doh' 组
      - match:
          # 匹配类型：通配符匹配
          type: wildcard
          # 匹配的通配符列表
          values:
            - "*.google.ac"
            - "*.ggpht.com"
        # 目标上游组
        upstream_group: "googledns_doh"

      # 规则 4: 阻止对特定广告域名的查询
      - match:
          # 匹配类型：精确匹配
          type: exact
          # 匹配值列表
          values: ["ads.example.com", "analytics.example.net"]
        # 特殊目标组：丢弃请求
        upstream_group: "__blackhole__"

    # --- 默认上游组配置 ---
    # 可选: 指定默认的上游组名称。
    # 如果一个 DNS 请求没有匹配 'rules' 中的任何规则：
    #   - 若指定了有效的组名（如此处的 "alidns_doh"），则使用该组的配置。
    #   - 若为 null、未设置或指定的组名无效，则使用顶层 'dns_resolver.upstream' 的配置。
    default_upstream_group: "alidns_doh"
