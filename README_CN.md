[English](./README.md) | ä¸­æ–‡

<div align="center">
    <h1>Oxide WDNS</h1>
    <h4>ğŸš€ ä¸€æ¬¾åŸºäº Rust æ„å»ºçš„é«˜æ€§èƒ½ DNS-over-HTTPS (DoH) ç½‘å…³ã€‚</h4>
    <img src="./images/logo.png" alt="logo">
</div>

<p align="center">
  <a href="#ç®€ä»‹">ç®€ä»‹</a>
  |
  <a href="#ä¸»è¦ç‰¹æ€§">ä¸»è¦ç‰¹æ€§</a>
  |
  <a href="#ç¼“å­˜æŒä¹…åŒ–æ€§èƒ½è€ƒé‡">ç¼“å­˜æŒä¹…åŒ–æ€§èƒ½è€ƒé‡</a>
  |
  <a href="#prometheus-æŒ‡æ ‡">Prometheus æŒ‡æ ‡</a>
  |
  <a href="#api-ç«¯ç‚¹">API ç«¯ç‚¹</a>
  |
  <a href="#å®‰è£…">å®‰è£…</a>
  |
  <a href="#ä½¿ç”¨">ä½¿ç”¨</a>
</p>

[![æ„å»ºçŠ¶æ€](https://github.com/shengyanli1982/oxide-wdns/actions/workflows/release.yml/badge.svg)](https://github.com/shengyanli1982/oxide-wdns/actions)

## ç®€ä»‹

### ğŸ¤” ä¸ºä»€ä¹ˆéœ€è¦å®‰å…¨ DNSï¼Ÿ

ä¼ ç»Ÿçš„ DNS æŸ¥è¯¢é€šå¸¸é€šè¿‡ç½‘ç»œä»¥æ˜æ–‡å½¢å¼ä¼ è¾“ï¼ˆé€šå¸¸é€šè¿‡ UDP 53 ç«¯å£ï¼‰ï¼Œè¿™ä¼šå¯¼è‡´å‡ ä¸ªé‡è¦é—®é¢˜ï¼š

1.  **éšç§æ³„éœ²ï¼š** ç½‘ç»œä¸Šçš„ä¸­é—´èŠ‚ç‚¹ï¼ˆå¦‚ ISPã€å…¬å…± Wi-Fi æä¾›å•†ï¼‰å¯ä»¥è½»æ˜“çª¥æ¢æ‚¨çš„ DNS æŸ¥è¯¢å†å²ï¼Œä»è€Œå¾—çŸ¥æ‚¨è®¿é—®äº†å“ªäº›ç½‘ç«™ã€‚
2.  **DNS åŠ«æŒ/æŠ•æ¯’ï¼š** æŸ¥è¯¢å¯èƒ½è¢«æ¶æ„ç¯¡æ”¹ï¼Œå°†æ‚¨é‡å®šå‘åˆ°é”™è¯¯æˆ–æ¶æ„çš„ç½‘ç«™ï¼ˆä¾‹å¦‚ï¼Œé’“é±¼ç½‘ç«™ï¼‰ã€‚
3.  **å®¡æŸ¥ä¸å°é”ï¼š** æŸäº›ç½‘ç»œç¯å¢ƒå¯èƒ½ä¼šé˜»æ­¢ç‰¹å®šåŸŸåçš„ DNS è§£æï¼Œä»è€Œé™åˆ¶äº’è”ç½‘è®¿é—®ã€‚

### ğŸ’¡ åŸºäº HTTP çš„å®‰å…¨ DNS (DoH) å¦‚ä½•è§£å†³è¿™äº›é—®é¢˜ï¼Ÿ

DNS-over-HTTPS (DoH) æ˜¯ä¸€ç§åè®® (RFC 8484)ï¼Œå®ƒå°† DNS æŸ¥è¯¢å°è£…åœ¨åŠ å¯†çš„ HTTPS è¿æ¥ä¸­ã€‚è¿™å¸¦æ¥äº†ä»¥ä¸‹å¥½å¤„ï¼š

-   **åŠ å¯†ä¼ è¾“ï¼š** DNS æŸ¥è¯¢å†…å®¹é€šè¿‡ HTTPS åŠ å¯†ï¼Œæœ‰æ•ˆé˜²æ­¢ä¸­é—´èŠ‚ç‚¹çš„çª¥æ¢å’Œç¯¡æ”¹ã€‚
-   **æµé‡æ··æ·†ï¼š** DoH æŸ¥è¯¢çœ‹èµ·æ¥ä¸å¸¸è§„ HTTPS æµé‡ç±»ä¼¼ï¼ˆä¸¤è€…é€šå¸¸éƒ½ä½¿ç”¨ 443 ç«¯å£ï¼‰ï¼Œä½¿å¾—åŸºäºç«¯å£æˆ–åè®®ç‰¹å¾çš„ DNS å°é”æ›´åŠ å›°éš¾ã€‚
-   **å¢å¼ºéšç§ä¸å®‰å…¨ï¼š** ç»“åˆ DNSSEC éªŒè¯ï¼ŒDoH ä¸º DNS è§£ææä¾›äº†æ›´å…¨é¢çš„å®‰å…¨ä¿éšœã€‚

### âœ¨ Oxide WDNS: æ‚¨çš„é«˜æ€§èƒ½ DoH ç½‘å…³å’Œå®¢æˆ·ç«¯

**Oxide WDNS** æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½ã€å®‰å…¨ä¸”å¯é çš„ DoH è§£å†³æ–¹æ¡ˆï¼Œä½¿ç”¨ Rust æ„å»ºï¼ŒåŒ…å«ä¸€ä¸ªæœåŠ¡å™¨ (`owdns`) å’Œä¸€ä¸ªå®¢æˆ·ç«¯å·¥å…· (`owdns-cli`)ã€‚

é‡è¦çš„æ˜¯ï¼ŒOxide WDNS æ—¨åœ¨æˆä¸ºä¼ ç»Ÿ DNS çš„**æ— ç¼æ‰©å±•**ï¼Œå¢å¼ºå…¶å®‰å…¨æ€§è€Œéå®Œå…¨å–ä»£ï¼›å®ƒä¸ç°æœ‰çš„ DNS åŸºç¡€è®¾æ–½å»ºç«‹äº†**åä½œå…³ç³»**ã€‚æ­¤å¤–ï¼Œ`owdns` æœåŠ¡å™¨è¢«è®¾è®¡ä¸ºä¸€ä¸ª**æ— çŠ¶æ€æœåŠ¡**ï¼Œè¿™æ„å‘³ç€æ‚¨å¯ä»¥è½»æ¾åœ°å¯¹å…¶è¿›è¡Œ**æ°´å¹³æ‰©å±•**ä»¥å¤„ç†é«˜å¹¶å‘è´Ÿè½½ã€‚

-   **æœåŠ¡å™¨ (`owdns`)ï¼š** å……å½“ DoH ç½‘å…³ï¼Œæ¥æ”¶æ¥è‡ªå®¢æˆ·ç«¯çš„ DoH è¯·æ±‚ï¼Œå®‰å…¨åœ°æŸ¥è¯¢ä¸Šæ¸¸ DNS æœåŠ¡å™¨ï¼Œå¹¶å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚å®ƒéå¸¸é€‚åˆéƒ¨ç½²åœ¨æœ¬åœ°ç½‘ç»œã€è¾¹ç¼˜èŠ‚ç‚¹æˆ–äº‘ç¯å¢ƒä¸­ï¼Œä¸ºæ‚¨çš„è®¾å¤‡æˆ–ç½‘ç»œæä¾›ç»Ÿä¸€ã€å®‰å…¨çš„ DNS è§£æå…¥å£ã€‚
-   **å®¢æˆ·ç«¯ (`owdns-cli`)ï¼š** ä¸€ä¸ªå¼ºå¤§çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œç”¨äºå‘ä»»ä½•ç¬¦åˆ RFC 8484 æ ‡å‡†çš„ DoH æœåŠ¡å™¨å‘é€æŸ¥è¯¢ï¼Œå¯ç”¨äºæµ‹è¯•ã€è°ƒè¯•å’ŒéªŒè¯ã€‚

Oxide WDNS é€šè¿‡æä¾›åŠ å¯†çš„ DNS é€šé“ã€æ”¯æŒ DNSSEC éªŒè¯ä»¥åŠæä¾›é«˜æ€§èƒ½å¤„ç†èƒ½åŠ›ï¼Œç›´æ¥è§£å†³äº†ä¼ ç»Ÿ DNS é¢ä¸´çš„éšç§æ³„éœ²ã€åŠ«æŒå’Œå°é”é—®é¢˜ã€‚

### ğŸ¯ åº”ç”¨åœºæ™¯

`owdns` çš„è®¾è®¡ä½¿å…¶ç‰¹åˆ«é€‚ç”¨äºéœ€è¦é«˜åº¦å®‰å…¨ã€å¯é å’Œé«˜æ€§èƒ½ DNS è§£æçš„ç¯å¢ƒï¼š

-   **å¤§è§„æ¨¡äº’è”ç½‘æœåŠ¡ï¼š** ä¸ºæµ·é‡ç”¨æˆ·ç¾¤å’Œå†…éƒ¨ç³»ç»Ÿæä¾›å¯æ‰©å±•ã€å®‰å…¨ä¸”é«˜åº¦å¯ç”¨çš„ DNS è§£æã€‚é€šè¿‡ DoH åŠ å¯†ä¿æŠ¤ç”¨æˆ·éšç§ï¼Œå¹¶é˜²æ­¢ DNS ç¼“å­˜æŠ•æ¯’å’ŒåŠ«æŒã€‚
-   **å·¥ä¸šäº’è”ç½‘ä¸æ™ºèƒ½åˆ¶é€ ï¼š** åœ¨å·¥ä¸šæ§åˆ¶ç³»ç»Ÿ (ICS) å’Œå·¥ä¸šç‰©è”ç½‘ (IIoT) ç¯å¢ƒä¸­ï¼Œç¡®ä¿è®¾å¤‡ã€ä¼ æ„Ÿå™¨å’Œå¹³å°ä¹‹é—´ DNS æŸ¥è¯¢çš„æœºå¯†æ€§å’Œå®Œæ•´æ€§ï¼Œé˜²æ­¢å…³é”®æ“ä½œæŒ‡ä»¤è¢«ç¯¡æ”¹æˆ–æ³„éœ²ã€‚
-   **ä¸­å°å‹äº‘æœåŠ¡æä¾›å•†ï¼š** ä¸ºç§Ÿæˆ·æä¾›å®‰å…¨çš„ DoH è§£æä½œä¸ºå¢å€¼æœåŠ¡ï¼Œå¢å¼ºå¹³å°å®‰å…¨èƒ½åŠ›å’Œå®¢æˆ·ä¿¡ä»»ã€‚`owdns` çš„é«˜æ€§èƒ½å’Œæ˜“éƒ¨ç½²æ€§ä½¿å…¶æˆä¸ºç†æƒ³é€‰æ‹©ã€‚
-   **ç‰©è”ç½‘ (IoT) å¹³å°ï¼š** ä¸ºå¤§é‡è¿æ¥çš„ç‰©è”ç½‘è®¾å¤‡æä¾›è½»é‡çº§ã€å®‰å…¨çš„ DNS è§£ææœåŠ¡ï¼Œé˜²æ­¢é€šè¿‡ DNS æ¬ºéª—æ”»å‡»åŠ«æŒè®¾å¤‡ï¼Œç‰¹åˆ«é€‚ç”¨äºèµ„æºå—é™çš„è¾¹ç¼˜è®¡ç®—åœºæ™¯ã€‚
-   **åŒ»ç–—ä¿å¥è¡Œä¸šï¼š** åœ¨è®¿é—®ç”µå­å¥åº·è®°å½• (EHR) å’Œè¿œç¨‹åŒ»ç–—å¹³å°ç­‰æ•æ„Ÿç³»ç»Ÿæ—¶ï¼Œä¿æŠ¤ DNS æŸ¥è¯¢çš„éšç§ï¼Œæ»¡è¶³ä¸¥æ ¼çš„æ•°æ®å®‰å…¨å’Œåˆè§„æ€§è¦æ±‚ï¼ˆä¾‹å¦‚ HIPAAï¼‰ã€‚
-   **æœºå™¨äººä¸è‡ªåŠ¨åŒ–ç³»ç»Ÿï¼š** ç¡®ä¿æœºå™¨äººé›†ç¾¤å’Œè‡ªåŠ¨åŒ–ç”Ÿäº§çº¿è®¾å¤‡åœ¨ä¸æ§åˆ¶ä¸­å¿ƒæˆ–äº‘å¹³å°é€šä¿¡æ—¶ï¼Œèƒ½å¤Ÿå®‰å…¨ã€å‡†ç¡®åœ°è§£æç›®æ ‡æœåŠ¡åœ°å€ï¼Œé˜²æ­¢å›  DNS é”™è¯¯å¯¼è‡´æ“ä½œä¸­æ–­æˆ–æ¶æ„æ§åˆ¶ã€‚

### ğŸ“ éƒ¨ç½²æ¶æ„å›¾

![architecture](./images/architecture.png)

## ä¸»è¦ç‰¹æ€§

**æœåŠ¡å™¨ (`owdns`)**

-   ğŸš€ **é«˜æ€§èƒ½ï¼š** åŸºäº Rust å’Œ Tokio æ„å»ºï¼Œå®ç°å¼‚æ­¥å¤„ç†å’Œé«˜å†…å­˜æ•ˆç‡ã€‚
-   ğŸ›¡ï¸ **å®‰å…¨å¯é ï¼š**
    -   å®Œæ•´å®ç° **RFC 8484 (DoH)** åè®®ã€‚
    -   æ”¯æŒ **DNSSEC** éªŒè¯ï¼Œç¡®ä¿å“åº”çš„çœŸå®æ€§å’Œå®Œæ•´æ€§ã€‚
    -   å†…ç½®åŸºäº IP çš„**é€Ÿç‡é™åˆ¶**å’Œä¸¥æ ¼çš„**è¾“å…¥éªŒè¯**ï¼Œä»¥é˜²å¾¡æ»¥ç”¨å’Œæ”»å‡»ã€‚
-   âš™ï¸ **çµæ´»é…ç½®ï¼š**
    -   åŒæ—¶æ”¯æŒ **Wireformat (`application/dns-message`)** å’Œ **JSON (`application/dns-json`)** ä¸¤ç§ DoH æ ¼å¼ã€‚
    -   æ”¯æŒ **GET** å’Œ **POST** HTTP æ–¹æ³•ã€‚
    -   æ”¯æŒ **HTTP/1.1** å’Œ **HTTP/2**ã€‚
    -   å¯é…ç½®å¤šä¸ª**ä¸Šæ¸¸ DNS è§£æå™¨**ï¼Œæ”¯æŒ UDPã€TCPã€DoT (DNS-over-TLS) å’Œ DoH åè®®ã€‚
    -   çµæ´»çš„ä¸Šæ¸¸é€‰æ‹©ç­–ç•¥ï¼ˆä¾‹å¦‚ï¼Œè½®è¯¢ã€éšæœºï¼‰ã€‚
-   ğŸ”€ **å¼ºå¤§çš„ DNS è·¯ç”±/åˆ†æµï¼š**
    -   å®šä¹‰å¤šä¸ª**ä¸Šæ¸¸ DNS æœåŠ¡å™¨ç»„** (`upstream_groups`)ã€‚æ¯ä¸ªç»„éƒ½å¯ä»¥ç‹¬ç«‹é…ç½®å…¶è‡ªå·±çš„è§£æå™¨ã€DNSSEC è®¾ç½®ï¼ˆä¾‹å¦‚ `enable_dnssec`ï¼‰ã€è¶…æ—¶å’Œå…¶ä»–å‚æ•°ã€‚
        -   å¦‚æœä¸€ä¸ªç»„æ²¡æœ‰æ˜¾å¼å®šä¹‰ç‰¹å®šè®¾ç½®ï¼ˆå¦‚ `enable_dnssec`ï¼‰ï¼Œå®ƒå°†ç»§æ‰¿ `dns_resolver.upstream` ä¸­ç›¸åº”çš„å…¨å±€é»˜è®¤å€¼ã€‚
        -   å¦‚æœä¸€ä¸ªç»„*ç¡®å®*æ˜¾å¼å®šä¹‰äº†æŸä¸ªè®¾ç½®ï¼Œåˆ™è¯¥å€¼*ä»…é€‚ç”¨äºè¯¥ç‰¹å®šç»„*ï¼Œè¦†ç›–å…¶æŸ¥è¯¢çš„å…¨å±€é»˜è®¤å€¼ã€‚è¿™ç§è¦†ç›–æ˜¯å±€éƒ¨çš„ï¼Œä¸ä¼šå½±å“å…¨å±€é»˜è®¤å€¼æœ¬èº«ï¼Œä¹Ÿä¸ä¼šå½±å“ä»»ä½•å…¶ä»– `upstream_group` çš„é…ç½®ï¼ˆåŒ…æ‹¬è¢«æŒ‡å®šä¸º `default_upstream_group` çš„ç»„ï¼Œé™¤éæ­¤ç»„*æ˜¯*é»˜è®¤ç»„ï¼‰ã€‚
    -   åŸºäºçµæ´»çš„**è§„åˆ™**å°† DNS æŸ¥è¯¢è·¯ç”±åˆ°ç‰¹å®šç»„ã€‚
    -   æ”¯æŒçš„è§„åˆ™ç±»å‹ï¼š**ç²¾ç¡®**åŸŸååŒ¹é…ã€**æ­£åˆ™è¡¨è¾¾å¼**æ¨¡å¼åŒ¹é…ã€**é€šé…ç¬¦**åŒ¹é…ï¼ˆä¾‹å¦‚ `*.example.com`ï¼‰ã€ä»æœ¬åœ°**æ–‡ä»¶**åŠ è½½çš„è§„åˆ™ä»¥åŠä»è¿œç¨‹ **URL** è·å–çš„è§„åˆ™ã€‚
    -   å†…ç½®ç‰¹æ®Šçš„ `__blackhole__` ç»„ï¼Œç”¨äº**é˜»æ­¢/ä¸¢å¼ƒ**ç‰¹å®šçš„ DNS æŸ¥è¯¢ï¼ˆä¾‹å¦‚ï¼Œç”¨äºå¹¿å‘Šæ‹¦æˆªï¼‰ã€‚
    -   ä¸ºä¸åŒ¹é…çš„æŸ¥è¯¢é…ç½®**é»˜è®¤ä¸Šæ¸¸ç»„**ï¼Œæˆ–å›é€€åˆ°å…¨å±€ä¸Šæ¸¸é…ç½®ã€‚
    -   æ”¯æŒä»è¿œç¨‹ URL **è‡ªåŠ¨å®šæœŸé‡æ–°åŠ è½½**è§„åˆ™ï¼Œå¹¶ä¸ºæ¯ä¸ª URL è§„åˆ™æä¾›**ç‹¬ç«‹å¯é…ç½®çš„æ›´æ–°é—´éš”**å’Œé«˜æ•ˆçš„åŸºäºå†…å®¹çš„æ›´æ–°æ£€æµ‹ã€‚
-   âš¡ **æ™ºèƒ½ç¼“å­˜ï¼š**
    -   å†…ç½®é«˜æ€§èƒ½ **LRU ç¼“å­˜**ï¼Œæ˜¾è‘—å‡å°‘å»¶è¿Ÿå’Œä¸Šæ¸¸è´Ÿè½½ã€‚
    -   æ”¯æŒ**å¦å®šç¼“å­˜**ï¼ˆåŒ…æ‹¬ `__blackhole__` å“åº”ï¼‰ã€‚
    -   å¯é…ç½®ç¼“å­˜å¤§å°å’Œ TTLã€‚
    -   **æŒä¹…åŒ–ç¼“å­˜ï¼š**
        -   å…è®¸æœåŠ¡åœ¨å…³é—­æ—¶å°†å†…å­˜ä¸­çš„ DNS ç¼“å­˜ä¿å­˜åˆ°ç£ç›˜ï¼Œå¹¶åœ¨ä¸‹æ¬¡å¯åŠ¨æ—¶é‡æ–°åŠ è½½ã€‚
        -   æ˜¾è‘—å‡å°‘æœåŠ¡é‡å¯åçš„"å†·å¯åŠ¨"æ—¶é—´ï¼Œå¹¶å¿«é€Ÿæ¢å¤ç¼“å­˜å‘½ä¸­ç‡ã€‚
        -   å‡å°‘é‡å¯ååˆå§‹å¯åŠ¨é˜¶æ®µå¯¹ä¸Šæ¸¸ DNS æœåŠ¡å™¨çš„å‹åŠ›ã€‚
        -   æ”¯æŒé…ç½®æŒä¹…åŒ–è·¯å¾„ã€å¯åŠ¨æ—¶æ˜¯å¦åŠ è½½ã€è¦ä¿å­˜çš„æœ€å¤§æ¡ç›®æ•°ä»¥åŠæ˜¯å¦è·³è¿‡è¿‡æœŸæ¡ç›®ã€‚
        -   æ”¯æŒå®šæœŸè‡ªåŠ¨å°†ç¼“å­˜ä¿å­˜åˆ°ç£ç›˜ã€‚
-   ğŸ”’ **EDNS å®¢æˆ·ç«¯å­ç½‘ (ECS) å¤„ç†ï¼š**
    -   çµæ´»æ§åˆ¶å¦‚ä½•å¤„ç†å’Œè½¬å‘å®¢æˆ·ç«¯ ECS ä¿¡æ¯ (RFC 7871)ï¼Œåœ¨ç”¨æˆ·éšç§ä¸ CDN ç­‰åœ°ç†æ•æ„ŸæœåŠ¡çš„æ€§èƒ½ä¹‹é—´å–å¾—å¹³è¡¡ã€‚
    -   æ”¯æŒä¸‰ç§ç­–ç•¥ï¼š
        -   `strip` (é»˜è®¤): åœ¨å‘ä¸Šæ¸¸å‘é€æŸ¥è¯¢ä¹‹å‰åˆ é™¤æ‰€æœ‰ ECS ä¿¡æ¯ï¼Œæœ€å¤§é™åº¦åœ°ä¿æŠ¤éšç§ã€‚
        -   `forward`: å°†å®¢æˆ·ç«¯çš„åŸå§‹ ECS ä¿¡æ¯ç›´æ¥è½¬å‘ç»™ä¸Šæ¸¸ã€‚
        -   `anonymize`: è½¬å‘åŒ¿åçš„ ECS ä¿¡æ¯ï¼ˆä¾‹å¦‚ï¼Œä¿ç•™ IPv4 çš„ /24 ç½‘ç»œï¼‰ã€‚
    -   å¯ä»¥å…¨å±€é…ç½®ï¼Œä¹Ÿå¯ä»¥ä¸ºç‰¹å®šçš„ä¸Šæ¸¸ DNS æœåŠ¡å™¨ç»„è¦†ç›–ã€‚
    -   **ECS æ„ŸçŸ¥ç¼“å­˜**ï¼šç¼“å­˜ä¼šè€ƒè™‘ ECS èŒƒå›´ï¼Œä»¥ç¡®ä¿æ›´å‡†ç¡®çš„åœ°ç†ä½ç½®å“åº”ã€‚
-   ğŸ“Š **å¯è§‚æµ‹æ€§ï¼š**
    -   é›†æˆ **Prometheus æŒ‡æ ‡** (`/metrics` ç«¯ç‚¹)ï¼Œä¾¿äºç›‘æ§æœåŠ¡çŠ¶æ€å’Œæ€§èƒ½ã€‚
    -   æä¾› **Kubernetes å¥åº·æ£€æŸ¥**ç«¯ç‚¹ (`/health`)ã€‚
    -   æ”¯æŒ**ç»“æ„åŒ–æ—¥å¿—** (Tracing)ã€‚
-   â˜ï¸ **äº‘åŸç”Ÿå‹å¥½ï¼š** æ˜“äºå®¹å™¨åŒ–å’Œéƒ¨ç½²ã€‚
-   ğŸ”Œ **ä¼˜é›…å…³é—­ï¼š** æ”¯æŒå¹³æ»‘çš„æœåŠ¡ç»ˆæ­¢ï¼Œç¡®ä¿æ­£åœ¨è¿›è¡Œçš„è¯·æ±‚å¾—ä»¥å®Œæˆã€‚

**å®¢æˆ·ç«¯ (`owdns-cli`)**

-   âœ… **åè®®å…¼å®¹æ€§ï¼š** æ”¯æŒ RFC 8484 Wireformat å’Œ Google/Cloudflare JSON æ ¼å¼ã€‚
-   ğŸ›¡ï¸ **DNSSEC æ”¯æŒï¼š** å¯ä»¥è¯·æ±‚ DNSSEC éªŒè¯ï¼ˆè®¾ç½® DO ä½ï¼‰ã€‚
-   ğŸ”§ **çµæ´»æ§åˆ¶ï¼š**
    -   æŒ‡å®šæŸ¥è¯¢**åŸŸå**å’Œ**è®°å½•ç±»å‹** (A, AAAA, MX, TXT ç­‰)ã€‚
    -   æ‰‹åŠ¨é€‰æ‹© **GET** æˆ– **POST** æ–¹æ³•ï¼ˆæˆ–è‡ªåŠ¨é€‰æ‹©ï¼‰ã€‚
    -   é€‰æ‹© **HTTP/1.1** æˆ– **HTTP/2**ã€‚
    -   æ”¯æŒå‘é€**åŸå§‹ DNS æŸ¥è¯¢è´Ÿè½½** (åå…­è¿›åˆ¶ç¼–ç )ã€‚
-   ğŸ” **å“åº”åˆ†æï¼š**
    -   æ¸…æ™°æ˜¾ç¤ºå·²è§£æçš„ DNS å“åº”ã€‚
    -   åŸºäº RCODEã€IP åœ°å€ç­‰æ ‡å‡†éªŒè¯å“åº”ã€‚
-   ğŸ› ï¸ **æ˜“ç”¨æ€§ï¼š**
    -   æ¸…æ™°çš„å‘½ä»¤è¡Œç•Œé¢ã€‚
    -   è¯¦ç»†çš„è¾“å‡ºæ¨¡å¼ (`-v, -vv, -vvv`) ç”¨äºè°ƒè¯•ã€‚
    -   æ”¯æŒè·³è¿‡ TLS è¯ä¹¦éªŒè¯ (`-k`)ï¼Œç”¨äºæµ‹è¯•æœ¬åœ°æˆ–è‡ªç­¾åè¯ä¹¦æœåŠ¡å™¨ã€‚

## ç¼“å­˜æŒä¹…åŒ–æ€§èƒ½è€ƒé‡

`DnsCache` æŒä¹…åŒ–æœºåˆ¶åˆ©ç”¨ `spawn_blocking`ï¼ˆç”¨äºä¿å­˜ï¼‰å’Œ `block_in_place`ï¼ˆç”¨äºåŠ è½½ï¼‰æ¥å®ç°å¼‚æ­¥æ ¸å¿ƒ I/O æ“ä½œï¼Œé˜²æ­¢ç›´æ¥é˜»å¡ä¸»å¼‚æ­¥è¿è¡Œæ—¶ã€‚ç„¶è€Œï¼Œåœ¨å…·æœ‰å¤§ç¼“å­˜å’Œé«˜å¹¶å‘çš„åœºæ™¯ä¸­ï¼Œåº”æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š

-   **ä¿å­˜æ“ä½œï¼š** æ•°æ®å‡†å¤‡æ­¥éª¤ï¼Œä¾‹å¦‚ç¼“å­˜è¿­ä»£å’Œæ’åºï¼Œåœ¨ä¿å­˜ä»»åŠ¡çš„å¼‚æ­¥ä¸Šä¸‹æ–‡ä¸­åŒæ­¥æ‰§è¡Œã€‚åœ¨é«˜è´Ÿè½½ä¸‹ï¼Œè¿™å¯èƒ½æˆä¸º CPU ç“¶é¢ˆå¹¶å¯¼è‡´ç¬æ—¶å†…å­˜å³°å€¼ã€‚
-   **åŠ è½½æ“ä½œï¼š** ååºåˆ—åŒ–å¤§é‡ç¼“å­˜æ•°æ®å¯èƒ½ä¼šå»¶é•¿æœåŠ¡å¯åŠ¨æ—¶é—´ã€‚åœ¨é«˜è´Ÿè½½æ¡ä»¶ä¸‹ï¼Œè¿™äº›å› ç´ å¯èƒ½ä¼šé—´æ¥å½±å“æ•´ä½“æ€§èƒ½å’Œå“åº”èƒ½åŠ›ã€‚

## Prometheus æŒ‡æ ‡

Oxide WDNS æä¾›å…¨é¢çš„ Prometheus æŒ‡æ ‡ï¼Œç”¨äºç›‘æ§æœåŠ¡çš„æ€§èƒ½ã€å¥åº·çŠ¶å†µå’Œè¿è¡ŒçŠ¶æ€ã€‚è¿™äº›æŒ‡æ ‡é€šè¿‡ `/metrics` ç«¯ç‚¹å…¬å¼€ï¼Œå¯ä»¥è¢« Prometheus æˆ–å…¶ä»–å…¼å®¹çš„ç›‘æ§ç³»ç»ŸæŠ“å–ã€‚

### HTTP æ€§èƒ½æŒ‡æ ‡

-   **owdns_http_requests_total** (è®¡æ•°å™¨) - HTTP è¯·æ±‚æ€»æ•°ï¼ŒæŒ‰æ–¹æ³•ã€è·¯å¾„ã€çŠ¶æ€ç ã€æ ¼å¼ (wire/json) å’Œ http_version (1.1/2) æ ‡è®°ã€‚
-   **owdns_http_request_duration_seconds** (ç›´æ–¹å›¾) - è¯·æ±‚å¤„ç†å»¶è¿Ÿï¼ŒæŒ‰æ–¹æ³•ã€è·¯å¾„å’Œæ ¼å¼æ ‡è®°ã€‚
-   **owdns_http_request_bytes** (ç›´æ–¹å›¾) -ä¼ å…¥ HTTP è¯·æ±‚çš„å¤§å°ã€‚
-   **owdns_http_response_bytes** (ç›´æ–¹å›¾) - ä¼ å‡º HTTP å“åº”çš„å¤§å°ã€‚
-   **owdns_rate_limit_rejected_total** (è®¡æ•°å™¨) - å› é€Ÿç‡é™åˆ¶è€Œè¢«æ‹’ç»çš„è¯·æ±‚æ•°ï¼ŒæŒ‰å®¢æˆ·ç«¯ IP æ ‡è®°ã€‚

### ç¼“å­˜æ•ˆç‡æŒ‡æ ‡

-   **owdns_cache_entries** (ä»ªè¡¨ç›˜) - ç¼“å­˜ä¸­çš„å½“å‰æ¡ç›®æ•°ã€‚
-   **owdns_cache_capacity** (ä»ªè¡¨ç›˜) - ç¼“å­˜çš„æœ€å¤§å®¹é‡ã€‚
-   **owdns_cache_operations_total** (è®¡æ•°å™¨) - æ€»ç¼“å­˜æ“ä½œæ•°ï¼ŒæŒ‰æ“ä½œç±»å‹ï¼ˆå‘½ä¸­/æœªå‘½ä¸­/æ’å…¥/é€å‡º/è¿‡æœŸï¼‰æ ‡è®°ã€‚
-   **owdns_cache_ttl_seconds** (ç›´æ–¹å›¾) - ç¼“å­˜æ¡ç›® TTL çš„åˆ†å¸ƒã€‚

### DNS æŸ¥è¯¢æŒ‡æ ‡

-   **owdns_dns_queries_total** (è®¡æ•°å™¨) - å¤„ç†çš„ DNS æŸ¥è¯¢æ€»æ•°ï¼ŒæŒ‰æŸ¥è¯¢ç±»å‹å’ŒçŠ¶æ€æ ‡è®°ã€‚
-   **owdns_dns_responses_total** (è®¡æ•°å™¨) - DNS å“åº”æ€»æ•°ï¼ŒæŒ‰å“åº”ç  (RCODE: NOERROR, NXDOMAIN, SERVFAIL ç­‰) æ ‡è®°ã€‚
-   **owdns_dns_query_type_total** (è®¡æ•°å™¨) - æŒ‰ DNS è®°å½•ç±»å‹ (A, AAAA, MX ç­‰) ç»Ÿè®¡çš„æŸ¥è¯¢æ•°ã€‚
-   **owdns_dns_query_duration_seconds** (ç›´æ–¹å›¾) - DNS æŸ¥è¯¢å¤„ç†æ—¶é—´ã€‚

### ä¸Šæ¸¸è§£æå™¨æŒ‡æ ‡

-   **owdns_upstream_requests_total** (è®¡æ•°å™¨) - å‘é€åˆ°ä¸Šæ¸¸è§£æå™¨çš„è¯·æ±‚æ€»æ•°ï¼ŒæŒ‰è§£æå™¨åœ°å€ã€åè®®å’Œ upstream_group æ ‡è®°ã€‚
-   **owdns_upstream_failures_total** (è®¡æ•°å™¨) - ä¸Šæ¸¸è§£æå™¨æ•…éšœæ€»æ•°ï¼ŒæŒ‰æ•…éšœç±»å‹ (error/timeout)ã€è§£æå™¨åœ°å€å’Œ upstream_group æ ‡è®°ã€‚
-   **owdns_upstream_duration_seconds** (ç›´æ–¹å›¾) - ä¸Šæ¸¸æŸ¥è¯¢å»¶è¿Ÿï¼ŒæŒ‰è§£æå™¨åœ°å€ã€åè®®å’Œ upstream_group æ ‡è®°ã€‚

### DNS è·¯ç”±æŒ‡æ ‡

-   **owdns_route_results_total** (è®¡æ•°å™¨) - æ€»è·¯ç”±ç»“æœæ•°ï¼ŒæŒ‰ç»“æœç±»å‹ (rule_match/blackhole/default) æ ‡è®°ã€‚
-   **owdns_route_rules** (ä»ªè¡¨ç›˜) - æ´»åŠ¨è·¯ç”±è§„åˆ™çš„æ•°é‡ï¼ŒæŒ‰è§„åˆ™ç±»å‹ (exact, regex, wildcard, file, url) æ ‡è®°ã€‚
-   **owdns_url_rule_update_duration_seconds** (ç›´æ–¹å›¾) - URL è§„åˆ™æ›´æ–°æ“ä½œå»¶è¿Ÿï¼ŒæŒ‰æ“ä½œé˜¶æ®µå’Œç»“æœçŠ¶æ€ (fetch/parse/update, success/failure) æ ‡è®°ã€‚

### DNSSEC éªŒè¯æŒ‡æ ‡

-   **owdns_dnssec_validations_total** (è®¡æ•°å™¨) - æ‰§è¡Œçš„ DNSSEC éªŒè¯æ¬¡æ•°ï¼ŒæŒ‰ç»“æœçŠ¶æ€ (success/failure) æ ‡è®°ã€‚

### ECS å¤„ç†æŒ‡æ ‡

-   **owdns_ecs_processed_total** (è®¡æ•°å™¨) - å¤„ç†çš„ ECS (EDNS å®¢æˆ·ç«¯å­ç½‘) æ“ä½œæ€»æ•°ï¼ŒæŒ‰ç­–ç•¥ (strip/forward/anonymize) æ ‡è®°ã€‚
-   **owdns_ecs_cache_matches_total** (è®¡æ•°å™¨) - ECS æ„ŸçŸ¥ç¼“å­˜åŒ¹é…æ•°ã€‚

### ç¼“å­˜æŒä¹…åŒ–æŒ‡æ ‡

-   **owdns_cache_persist_operations_total** (è®¡æ•°å™¨) - æ€»ç¼“å­˜æŒä¹…åŒ–æ“ä½œæ•°ï¼ŒæŒ‰æ“ä½œç±»å‹ (save/load) æ ‡è®°ã€‚
-   **owdns_cache_persist_duration_seconds** (ç›´æ–¹å›¾) - ç¼“å­˜æŒä¹…åŒ–æ“ä½œå»¶è¿Ÿï¼ŒæŒ‰æ“ä½œç±»å‹ (save/load) æ ‡è®°ã€‚

è¿™äº›æŒ‡æ ‡å¯ä»¥å¯¹ Oxide WDNS çš„æ€§èƒ½å’Œè¡Œä¸ºè¿›è¡Œè¯¦ç»†ç›‘æ§å’Œåˆ†æï¼Œä»è€Œæ›´å®¹æ˜“è¯†åˆ«é—®é¢˜ã€ä¼˜åŒ–é…ç½®å¹¶ç¡®ä¿æœåŠ¡æ»¡è¶³æ‚¨çš„æ€§èƒ½è¦æ±‚ã€‚

## API ç«¯ç‚¹

Oxide WDNS æä¾›ä»¥ä¸‹ HTTP API ç«¯ç‚¹ï¼Œç”¨äº DNS è§£æå’ŒæœåŠ¡ç›‘æ§ï¼š

### RFC 8484 DoH ç«¯ç‚¹

-   **GET /dns-query**

    -   _å†…å®¹ç±»å‹_: application/dns-message
    -   _å‚æ•°_: `dns` (Base64url ç¼–ç çš„ DNS è¯·æ±‚)
    -   _æè¿°_: ä½¿ç”¨ RFC 8484 wireformat æŸ¥è¯¢ DNS è®°å½•ï¼ŒDNS è¯·æ±‚ä»¥ base64url ç¼–ç 
    -   _ç¤ºä¾‹_: `GET /dns-query?dns=AAABAAABAAAAAAAAA3d3dwdleGFtcGxlA2NvbQAAAQAB`

-   **POST /dns-query**
    -   _å†…å®¹ç±»å‹_: application/dns-message
    -   _è¯·æ±‚ä½“_: äºŒè¿›åˆ¶ DNS æŸ¥è¯¢æŠ¥æ–‡
    -   _æè¿°_: é€šè¿‡åœ¨è¯·æ±‚ä½“ä¸­æäº¤åŸå§‹ DNS æŠ¥æ–‡æ¥æŸ¥è¯¢ DNS è®°å½•
    -   _æ³¨æ„_: å¯¹äºå¤§å‹æŸ¥è¯¢æ›´é«˜æ•ˆï¼Œå› ä¸ºå®ƒé¿å…äº† base64 ç¼–ç å¼€é”€

### Google/Cloudflare JSON API å…¼å®¹ç«¯ç‚¹

-   **GET /resolve**
    -   _å†…å®¹ç±»å‹_: application/dns-json
    -   _å‚æ•°_:
        -   `name` (å¿…éœ€): è¦æŸ¥è¯¢çš„åŸŸå (ä¾‹å¦‚ example.com)
        -   `type` (å¯é€‰): DNS è®°å½•ç±»å‹ï¼Œå¯ä»¥æ˜¯æ•°å­—æˆ–å­—ç¬¦ä¸² (é»˜è®¤ä¸º 1ï¼Œä»£è¡¨ A è®°å½•)
        -   `dnssec` (å¯é€‰): å¯ç”¨ DNSSEC éªŒè¯ (true/false)
        -   `cd` (å¯é€‰): ç¦ç”¨ DNSSEC éªŒè¯æ£€æŸ¥ (true/false)
        -   `do` (å¯é€‰): è®¾ç½® DNSSEC OK ä½ (true/false)
    -   _æè¿°_: æŸ¥è¯¢ DNS è®°å½•ï¼Œç»“æœä»¥ JSON æ ¼å¼è¿”å›
    -   _ç¤ºä¾‹_: `GET /resolve?name=example.com&type=A&dnssec=true`

### ç›‘æ§å’Œå¥åº·æ£€æŸ¥ç«¯ç‚¹

-   **GET /health**

    -   _æè¿°_: ç”¨äºç›‘æ§æœåŠ¡å’Œ Kubernetes æ¢é’ˆçš„å¥åº·æ£€æŸ¥ç«¯ç‚¹
    -   _è¿”å›_: æœåŠ¡å¥åº·æ—¶è¿”å› 200 OK

-   **GET /metrics**
    -   _æè¿°_: Prometheus æŒ‡æ ‡ç«¯ç‚¹ï¼Œå…¬å¼€æ€§èƒ½å’Œæ“ä½œç»Ÿè®¡ä¿¡æ¯
    -   _å†…å®¹ç±»å‹_: text/plain

### è°ƒè¯•æ¨¡å¼ç«¯ç‚¹

å½“æœåŠ¡å™¨ä»¥è°ƒè¯•æ ‡å¿— `-d` è¿è¡Œæ—¶ï¼Œå¯ä»¥ä½¿ç”¨å…¶ä»–å¼€å‘äººå‘˜å·¥å…·ï¼š

-   **GET /scalar**
    -   _æè¿°_: äº¤äº’å¼ API æ–‡æ¡£å’Œæµ‹è¯•ç”¨æˆ·ç•Œé¢
    -   _æ³¨æ„_: ä»…åœ¨æœåŠ¡å™¨ä»¥è°ƒè¯•æ¨¡å¼å¯åŠ¨æ—¶å¯ç”¨

![scalar](./images/scalar.png)

è¿™äº›ç«¯ç‚¹éµå¾ªæ ‡å‡†çš„ HTTP çŠ¶æ€ç ï¼š

-   200: æŸ¥è¯¢æˆåŠŸ
-   400: æ— æ•ˆçš„è¯·æ±‚å‚æ•°
-   415: ä¸æ”¯æŒçš„åª’ä½“ç±»å‹
-   429:è¶…å‡ºé€Ÿç‡é™åˆ¶
-   500: å¤„ç†è¿‡ç¨‹ä¸­çš„æœåŠ¡å™¨é”™è¯¯

## å®‰è£…

æ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å®‰è£… Oxide WDNSï¼š

1.  **ä» GitHub Releases ä¸‹è½½é¢„ç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶ (æ¨è):**
    è®¿é—®é¡¹ç›®çš„ [GitHub Releases](https://github.com/shengyanli1982/oxide-wdns/releases) é¡µé¢ï¼Œä¸‹è½½é€‚ç”¨äºæ‚¨æ“ä½œç³»ç»Ÿçš„æœ€æ–°ç‰ˆæœ¬ã€‚

2.  **ä»æºä»£ç ç¼–è¯‘:**
    ç¡®ä¿æ‚¨å·²å®‰è£… [Rust å·¥å…·é“¾](https://www.rust-lang.org/tools/install)ã€‚

    ```bash
    # å…‹éš†ä»“åº“
    git clone https://github.com/shengyanli1982/oxide-wdns.git
    cd oxide-wdns

    # ç¼–è¯‘æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ (Release æ¨¡å¼ï¼Œå¸¦ä¼˜åŒ–)
    cargo build --release

    # ç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶ä½äº ./target/release/
    # æœåŠ¡å™¨: owdns (Windows ä¸Šä¸º owdns.exe)
    # å®¢æˆ·ç«¯: owdns-cli (Windows ä¸Šä¸º owdns-cli.exe)
    ```

3.  **ä½¿ç”¨ Docker (æ¨èç”¨äºå®¹å™¨åŒ–ç¯å¢ƒ):**
    åœ¨å®¹å™¨åŒ–ç¯å¢ƒä¸­è¿è¡Œ Oxide WDNS æœ€ç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨ Dockerã€‚

    ```bash
    # ä» Docker Hub æ‹‰å–æœ€æ–°é•œåƒ
    # æˆ– docker pull ghcr.io/shengyanli1982/oxide-wdns-arm64:latest
    docker pull ghcr.io/shengyanli1982/oxide-wdns-x64:latest

    # è¿è¡Œå®¹å™¨
    # å°†å®¹å™¨çš„ 3053 ç«¯å£æ˜ å°„åˆ°ä¸»æœºçš„ 3053 ç«¯å£
    # å°†æœ¬åœ°é…ç½®æ–‡ä»¶æŒ‚è½½åˆ°å®¹å™¨ä¸­
    docker run -d \
      --name owdns \
      -p 3053:3053 \
      -v $(pwd)/config.yaml:/app/config.yaml \
      ghcr.io/shengyanli1982/oxide-wdns-x64:latest
    # æˆ– ghcr.io/shengyanli1982/oxide-wdns-arm64:latest

    # åœ¨å®¹å™¨ä¸­ä½¿ç”¨å®¢æˆ·ç«¯ (owdns-cli)ï¼š
    docker exec owdns /app/owdns-cli [é€‰é¡¹] [å‚æ•°]

    # ä¾‹å¦‚ï¼Œä½¿ç”¨ DoH æœåŠ¡å™¨æŸ¥è¯¢ example.comï¼š
    docker exec owdns /app/owdns-cli https://cloudflare-dns.com/dns-query example.com
    ```

## ä½¿ç”¨

### æœåŠ¡å™¨ (`owdns`)

1.  **é…ç½®æ–‡ä»¶ (`config.yaml`):**
    æœåŠ¡å™¨é€šè¿‡ YAML æ–‡ä»¶è¿›è¡Œé…ç½®ã€‚æ‚¨éœ€è¦åˆ›å»ºä¸€ä¸ª `config.yaml` æ–‡ä»¶ï¼ˆæˆ–ä½¿ç”¨ `-c` æŒ‡å®šå¦ä¸€ä¸ªè·¯å¾„ï¼‰ã€‚æœ‰å…³å®Œæ•´çš„ç»“æ„å’Œé»˜è®¤å€¼ï¼Œè¯·å‚é˜… `config.default.yaml`ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªå±•ç¤ºåŒ…æ‹¬ DNS è·¯ç”±åœ¨å†…çš„å…³é”®åŠŸèƒ½çš„ç¤ºä¾‹ï¼š

    ```yaml
    # config.yaml - å¸¦è·¯ç”±çš„ç¤ºä¾‹

    # HTTP æœåŠ¡å™¨é…ç½®
    http_server:
        listen_addr: "127.0.0.1:3053"
        timeout: 120
        rate_limit:
            enabled: true
            per_ip_rate: 100
            per_ip_concurrent: 10

    # DNS è§£æå™¨é…ç½®
    dns_resolver:
        # HTTP å®¢æˆ·ç«¯é…ç½® (ç”¨äº DoH ä¸Šæ¸¸å’Œè·å– URL è§„åˆ™)
        http_client:
            timeout: 120
            pool:
                idle_timeout: 30
                max_idle_connections: 10
            request:
                user_agent: "Oxide-WDNS Client"
                ip_header_names: ["X-Forwarded-For", "X-Real-IP", "CF-Connecting-IP"]

        # ç¼“å­˜é…ç½®
        cache:
            enabled: true
            size: 10000
            ttl:
                min: 60
                max: 86400
                negative: 300 # å¦å®šå“åº” (NXDOMAIN) çš„ TTLï¼ŒåŒ…æ‹¬ __blackhole__
            # --- æŒä¹…åŒ–ç¼“å­˜é…ç½® ---
            persistence:
                # å¯ç”¨ç¼“å­˜æŒä¹…åŒ–ã€‚
                enabled: true
                # ç¼“å­˜æ–‡ä»¶è·¯å¾„ã€‚
                path: "./cache.dat"
                # å¯åŠ¨æ—¶è‡ªåŠ¨ä»ç£ç›˜åŠ è½½ç¼“å­˜ã€‚
                load_on_startup: true
                # (å¯é€‰) ä¿å­˜åˆ°ç£ç›˜çš„æœ€å¤§ç¼“å­˜æ¡ç›®æ•°ã€‚
                max_items_to_save: 0
                # ä»ç£ç›˜åŠ è½½æ—¶è·³è¿‡å·²è¿‡æœŸçš„æ¡ç›®ã€‚
                skip_expired_on_load: true
                # å…³é—­æœŸé—´ä¿å­˜ç¼“å­˜çš„è¶…æ—¶æ—¶é—´ (ç§’)ã€‚
                shutdown_save_timeout_secs: 30
                # --- å®šæœŸä¿å­˜é…ç½® ---
                periodic:
                    # å¯ç”¨å®šæœŸä¿å­˜ç¼“å­˜ã€‚
                    enabled: true
                    # å®šæœŸä¿å­˜çš„é—´éš”æ—¶é—´ (ç§’)ã€‚
                    interval_secs: 3600

        # --- å…¨å±€/é»˜è®¤ä¸Šæ¸¸ DNS é…ç½® ---
        # æœ¬èŠ‚å®šä¹‰äº†å„ç§å‚æ•°çš„å…¨å±€é»˜è®¤å€¼ï¼Œä¾‹å¦‚ 'enable_dnssec' å’Œ 'query_timeout'ã€‚
        # å¦‚æœç‰¹å®šç»„å†…æœªæ˜¾å¼è¦†ç›–ï¼Œåˆ™ä¸Šæ¸¸ç»„å°†ç»§æ‰¿è¿™äº›å…¨å±€é»˜è®¤å€¼ã€‚
        # è‡³å…³é‡è¦çš„æ˜¯ï¼Œè¿™äº›å…¨å±€é»˜è®¤å€¼æœ¬èº«ä¸ä¼šè¢«ä»»ä½•ç‰¹å®šäºç»„çš„è¦†ç›–æ‰€ä¿®æ”¹ã€‚
        upstream:
            enable_dnssec: true # DNSSEC çš„å…¨å±€é»˜è®¤å€¼ã€‚é™¤éç»„è‡ªè¡Œå®šä¹‰ï¼Œå¦åˆ™ç”±ç»„ç»§æ‰¿ã€‚
            query_timeout: 30 # å…¨å±€é»˜è®¤æŸ¥è¯¢è¶…æ—¶æ—¶é—´ (ç§’)ã€‚
            resolvers:
                - address: "1.1.1.1:53"
                  protocol: "udp"
                - address: "8.8.8.8:53"
                  protocol: "udp"
                # DoT/DoH ä¸Šæ¸¸ç¤ºä¾‹:
                # - address: "cloudflare-dns.com@1.1.1.1:853"
                #   protocol: "dot"
                # - address: "https://cloudflare-dns.com/dns-query"
                #   protocol: "doh"

        # --- EDNS å®¢æˆ·ç«¯å­ç½‘ (ECS) å¤„ç†ç­–ç•¥é…ç½® ---
        ecs_policy:
            # å¯ç”¨ ECS å¤„ç†ç­–ç•¥ã€‚
            # é»˜è®¤å€¼: false (ä½†å»ºè®®åœ¨éœ€è¦å¯ç”¨åŠŸèƒ½æ—¶è®¾ç½®ä¸º true)
            enabled: true
            # å…¨å±€ ECS å¤„ç†ç­–ç•¥ã€‚
            # å¯èƒ½çš„å€¼: "strip", "forward", "anonymize"
            strategy: "strip"
            # åŒ¿ååŒ–è®¾ç½®ï¼Œå½“ç­–ç•¥ä¸º "anonymize" æ—¶æœ‰æ•ˆã€‚
            anonymization:
                # å¯¹äº IPv4 åœ°å€ï¼Œè¦ä¿ç•™çš„ç½‘ç»œå‰ç¼€é•¿åº¦ (1-32)ã€‚é»˜è®¤å€¼: 24
                ipv4_prefix_length: 24
                # å¯¹äº IPv6 åœ°å€ï¼Œè¦ä¿ç•™çš„ç½‘ç»œå‰ç¼€é•¿åº¦ (1-128)ã€‚é»˜è®¤å€¼: 48
                ipv6_prefix_length: 48

    # --- DNS è·¯ç”±é…ç½® ---
    routing:
        # å¯ç”¨ DNS è·¯ç”±åŠŸèƒ½
        enabled: true

        # å®šä¹‰ä¸Šæ¸¸ DNS æœåŠ¡å™¨ç»„
        # æ¯ä¸ªç»„ç‹¬ç«‹é…ç½®å…¶å‚æ•°ã€‚ç‰¹å®šäºç»„çš„è®¾ç½® (ä¾‹å¦‚ 'enable_dnssec: false')
        # ä»…è¦†ç›–è¯¥ç»„çš„å…¨å±€é»˜è®¤å€¼ã€‚å®ƒä¸ä¼šæ”¹å˜å…¨å±€é»˜è®¤å€¼æœ¬èº«ï¼Œä¹Ÿä¸ä¼šå½±å“å…¶ä»–ç»„ã€‚
        # å¦‚æœç»„å†…æœªæŒ‡å®šæŸä¸ªè®¾ç½®ï¼Œåˆ™å®ƒå°†ä» 'dns_resolver.upstream' ç»§æ‰¿ã€‚
        upstream_groups:
            - name: "clean_dns" # ç¤ºä¾‹ï¼šä¸€ä¸ªçº¯å‡€çš„ DNS ç»„
                # è¯¥ç»„æœªæŒ‡å®š 'enable_dnssec' æˆ– 'query_timeout'ã€‚
                # å› æ­¤ï¼Œå®ƒå°†ä» 'dns_resolver.upstream' ç»§æ‰¿è¿™äº›å€¼ (ä¾‹å¦‚ enable_dnssec: true)ã€‚
                resolvers:
                    - address: "https://dns.quad9.net/dns-query"
                      protocol: "doh"
                    - address: "9.9.9.9:53"
                      protocol: "udp"
                # å¯é€‰ï¼šä¸ºæ­¤ç»„è¦†ç›–å…¨å±€ ECS ç­–ç•¥
                ecs_policy:
                    enabled: true
                    strategy: "forward" # è¯¥ç»„å°†è½¬å‘åŸå§‹ ECS

            - name: "domestic_dns" # ç¤ºä¾‹ï¼šé’ˆå¯¹å›½å†…åŸŸåä¼˜åŒ–çš„ DNS ç»„
                # è¯¥ç»„æ˜¾å¼è¦†ç›–äº† 'enable_dnssec' å’Œ 'query_timeout'ã€‚
                # è¿™äº›è¦†ç›–ä»…é€‚ç”¨äº 'domestic_dns' ç»„ã€‚
                # å®ƒä»¬ä¸ä¼šæ›´æ”¹ 'dns_resolver.upstream' ä¸­çš„å…¨å±€é»˜è®¤å€¼ï¼Œ
                # ä¹Ÿä¸ä¼šå½±å“ 'clean_dns' æˆ–ä»»ä½•å…¶ä»–ç»„å¦‚ä½•ç¡®å®šå…¶ DNSSEC è¡Œä¸ºã€‚
                enable_dnssec: false # ä»…ä¸º 'domestic_dns' è¦†ç›–ã€‚
                query_timeout: 15   # ä»…ä¸º 'domestic_dns' è¦†ç›–ã€‚
                resolvers:
                    - address: "https://dns.alidns.com/dns-query"
                      protocol: "doh"
                    - address: "223.5.5.5:53"
                      protocol: "udp"
                # å¯é€‰ï¼šä¸ºæ­¤ç»„è¦†ç›–å…¨å±€ ECS ç­–ç•¥å¹¶ä½¿ç”¨åŒ¿ååŒ–
                ecs_policy:
                    enabled: true
                    strategy: "anonymize"
                    anonymization:
                        ipv4_prefix_length: 24
                        ipv6_prefix_length: 56 # ä¸ºæ­¤ç»„æŒ‡å®šä¸åŒçš„ IPv6 åŒ¿ååŒ–çº§åˆ«

            - name: "adblock_dns" # ç¤ºä¾‹ï¼šå·²çŸ¥ç”¨äºå¹¿å‘Šæ‹¦æˆªçš„ DNS ç»„
                resolvers:
                    - address: "https://dns.adguard-dns.com/dns-query"
                      protocol: "doh"

        # å®šä¹‰è·¯ç”±è§„åˆ™ (æŒ‰é¡ºåºå¤„ç†ï¼Œç¬¬ä¸€ä¸ªåŒ¹é…çš„è§„åˆ™ç”Ÿæ•ˆ)
        rules:
            # è§„åˆ™ 1: ä½¿ç”¨ç‰¹æ®Šçš„ __blackhole__ ç»„é˜»æ­¢ç‰¹å®šçš„å¹¿å‘ŠåŸŸå
            - match:
                type: exact
                values: ["ads.example.com", "analytics.example.org"]
                upstream_group: "__blackhole__" # ç‰¹æ®Šç»„ï¼šä¸¢å¼ƒæŸ¥è¯¢ï¼Œè¿”å› NXDOMAIN

            # è§„åˆ™ 2: å°†ç‰¹å®šçš„å›½å†…åŸŸåè·¯ç”±åˆ° domestic_dns ç»„
            - match:
                type: exact
                values: ["bilibili.com", "qq.com", "taobao.com", "jd.com"]
                upstream_group: "domestic_dns"

            # è§„åˆ™ 3: å°†åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼çš„åŸŸåè·¯ç”±åˆ° clean_dns ç»„
            - match:
                type: regex
                values:
                    - "^(.*\.)?(google|youtube|gstatic)\.com$"
                    - "^(.*\.)?github\.com$"
                upstream_group: "clean_dns"

            # è§„åˆ™ 4: å°†åŒ¹é…é€šé…ç¬¦çš„åŸŸåè·¯ç”±åˆ° clean_dns ç»„
            - match:
                type: wildcard
                values: ["*.googleapis.com", "*.ggpht.com"]
                upstream_group: "clean_dns"

            # è§„åˆ™ 5: ä»æœ¬åœ°æ–‡ä»¶åŠ è½½å›½å†…åŸŸåï¼Œå¹¶å°†å…¶è·¯ç”±åˆ° domestic_dns ç»„
            # æœ‰å…³æ–‡ä»¶æ ¼å¼è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…ä¸‹é¢çš„"åŸŸååˆ—è¡¨æ–‡ä»¶æ ¼å¼"éƒ¨åˆ†ã€‚
            - match:
                type: file
                path: "/etc/oxide-wdns/china_domains.txt"
                upstream_group: "domestic_dns"

            # è§„åˆ™ 6: ä»è¿œç¨‹ URL åŠ è½½å¹¿å‘ŠåŸŸåï¼Œå¹¶ä½¿ç”¨ __blackhole__ é˜»æ­¢å®ƒä»¬
            # æ¥è‡ª URL çš„è§„åˆ™ä¼šå®šæœŸè·å–ã€‚è¯·å‚é˜…ä¸‹é¢çš„"åŸŸååˆ—è¡¨æ–‡ä»¶æ ¼å¼"ã€‚
            - match:
                type: url
                url: "https://raw.githubusercontent.com/privacy-protection-tools/anti-AD/master/anti-ad-domains.txt"
                upstream_group: "__blackhole__"
                # --- URL è§„åˆ™å®šæœŸæ›´æ–°é…ç½® ---
                periodic:
                    # å¯ç”¨æ­¤ URL è§„åˆ™çš„å®šæœŸæ›´æ–°ã€‚
                    # å¯ç”¨åï¼Œç³»ç»Ÿå°†å®šæœŸè·å–å’Œæ›´æ–°è§„åˆ™å†…å®¹
                    # å¦‚æœæœªæŒ‡å®šï¼Œåˆ™é»˜è®¤ä¸º false
                    enabled: true
                    # å®šæœŸè·å–çš„æ›´æ–°é—´éš” (ç§’) (ä¾‹å¦‚ 3600 = 1 å°æ—¶)ã€‚
                    # æ¯ä¸ª URL è§„åˆ™éƒ½å¯ä»¥æœ‰è‡ªå·±ç‹¬ç«‹çš„æ›´æ–°é—´éš”ã€‚
                    # ä»…å½“ periodic.enabled ä¸º true æ—¶æœ‰æ•ˆã€‚
                    interval_secs: 3600
                    # ç³»ç»Ÿä½¿ç”¨ xxHash (xxh64) å®ç°åŸºäºå†…å®¹çš„æ›´æ–°æ£€æµ‹ï¼Œ
                    # ä»¥é¿å…åœ¨è¿œç¨‹å†…å®¹æœªæ›´æ”¹æ—¶ä¸å¿…è¦çš„è§£æå’Œæ›´æ–°ï¼Œ
                    # æœ€å¤§é™åº¦åœ°å‡å°‘èµ„æºæ¶ˆè€—å’Œå†™é”å®šäº‰ç”¨ã€‚

        # å¯é€‰ï¼šæœªåŒ¹é…ä»»ä½•è§„åˆ™çš„æŸ¥è¯¢çš„é»˜è®¤ä¸Šæ¸¸ç»„ã€‚
        # å¦‚æœæ­¤å¤„æŒ‡å®šäº† 'upstream_groups' ä¸­çš„æœ‰æ•ˆç»„å (ä¾‹å¦‚ "clean_dns")ï¼š
        #   - æœªåŒ¹é…çš„æŸ¥è¯¢ç”±æ­¤æŒ‡å®šçš„é»˜è®¤ç»„å¤„ç†ã€‚
        #   - è¿™äº›æŸ¥è¯¢çš„ DNSSEC è¡Œä¸º (å’Œå…¶ä»–å‚æ•°) å®Œå…¨ç”±æ­¤æŒ‡å®šé»˜è®¤ç»„çš„é…ç½®å†³å®š
        #     (å³å…¶è‡ªèº«çš„æ˜¾å¼è®¾ç½®æˆ–åœ¨æ²¡æœ‰æ˜¾å¼è®¾ç½®æ—¶ç»§æ‰¿çš„å…¨å±€é»˜è®¤å€¼)ã€‚
        #   - å…¶ä»–éé»˜è®¤ç»„çš„ 'enable_dnssec' è®¾ç½®å¯¹æ­¤é»˜è®¤è¡Œä¸ºæ²¡æœ‰å½±å“ã€‚
        # å¦‚æœä¸º nullã€çœç•¥æˆ–ç»™å®šäº†æ— æ•ˆçš„ç»„åï¼Œåˆ™ç›´æ¥ä½¿ç”¨å…¨å±€ `dns_resolver.upstream` é…ç½®ã€‚
        default_upstream_group: "clean_dns"

    ```

    _è¯·æ ¹æ®æ‚¨çš„éœ€æ±‚ä¿®æ”¹é…ç½®ã€‚è¯·æ³¨æ„ï¼Œ`routing` éƒ¨åˆ†æä¾›äº†å¯¹ DNS è§£æè¡Œä¸ºçš„å¼ºå¤§æ§åˆ¶ã€‚_

1.5. **é…ç½®é€‰é¡¹å‚è€ƒï¼š**

ä»¥ä¸‹æ˜¯ `config.yaml` ä¸­æ‰€æœ‰å¯ç”¨é…ç½®é€‰é¡¹çš„è¯¦ç»†å‚è€ƒè¡¨ï¼š

##### HTTP æœåŠ¡å™¨é…ç½®

| é€‰é¡¹                                       | ç±»å‹   | é»˜è®¤å€¼             | æè¿°                                       |
| ------------------------------------------ | ------ | ------------------ | ------------------------------------------ |
| `http_server.listen_addr`                  | å­—ç¬¦ä¸² | `"127.0.0.1:3053"` | æœåŠ¡å™¨ä¾¦å¬åœ°å€å’Œç«¯å£                       |
| `http_server.timeout`                      | æ•´æ•°   | 120                | æœåŠ¡å™¨è¿æ¥è¶…æ—¶æ—¶é—´ (ç§’)                    |
| `http_server.rate_limit.enabled`           | å¸ƒå°”å€¼ | false              | æ˜¯å¦å¯ç”¨é€Ÿç‡é™åˆ¶                           |
| `http_server.rate_limit.per_ip_rate`       | æ•´æ•°   | 100                | æ¯ä¸ª IP åœ°å€æ¯ç§’æœ€å¤§è¯·æ±‚æ•° (èŒƒå›´: 1-1000)  |
| `http_server.rate_limit.per_ip_concurrent` | æ•´æ•°   | 10                 | æ¯ä¸ª IP åœ°å€çš„æœ€å¤§å¹¶å‘è¯·æ±‚æ•° (èŒƒå›´: 1-100) |

##### DNS è§£æå™¨é…ç½®

###### HTTP å®¢æˆ·ç«¯é€‰é¡¹

| é€‰é¡¹                                                 | ç±»å‹       | é»˜è®¤å€¼                                               | æè¿°                                     |
| ---------------------------------------------------- | ---------- | ---------------------------------------------------- | ---------------------------------------- |
| `dns_resolver.http_client.timeout`                   | æ•´æ•°       | 120                                                  | HTTP å®¢æˆ·ç«¯è¯·æ±‚è¶…æ—¶æ—¶é—´ (ç§’)             |
| `dns_resolver.http_client.pool.idle_timeout`         | æ•´æ•°       | 30                                                   | è¿æ¥æ± ä¸­è¿æ¥çš„æœ€å¤§ç©ºé—²æ—¶é—´ (ç§’)          |
| `dns_resolver.http_client.pool.max_idle_connections` | æ•´æ•°       | 10                                                   | è¿æ¥æ± ä¸­è¦ä¿ç•™çš„æœ€å¤§ç©ºé—²è¿æ¥æ•°           |
| `dns_resolver.http_client.request.user_agent`        | å­—ç¬¦ä¸²     | "Mozilla/5.0 ..."                                    | HTTP è¯·æ±‚çš„ User-Agent æ ‡å¤´              |
| `dns_resolver.http_client.request.ip_header_names`   | å­—ç¬¦ä¸²æ•°ç»„ | ["X-Forwarded-For", "X-Real-IP", "CF-Connecting-IP"] | ç”¨äºè¯†åˆ«å®¢æˆ·ç«¯ IP çš„æ ‡å¤´åç§°ï¼ŒæŒ‰é¡ºåºæ£€æŸ¥ |

###### ç¼“å­˜é€‰é¡¹

| é€‰é¡¹                                                        | ç±»å‹   | é»˜è®¤å€¼        | æè¿°                                                |
| ----------------------------------------------------------- | ------ | ------------- | --------------------------------------------------- |
| `dns_resolver.cache.enabled`                                | å¸ƒå°”å€¼ | false         | æ˜¯å¦å¯ç”¨ DNS ç¼“å­˜                                   |
| `dns_resolver.cache.size`                                   | æ•´æ•°   | 10000         | ç¼“å­˜ä¸­çš„æœ€å¤§æ¡ç›®æ•°                                  |
| `dns_resolver.cache.ttl.min`                                | æ•´æ•°   | 60            | ç¼“å­˜æ¡ç›®çš„æœ€å° TTL (ç§’)                             |
| `dns_resolver.cache.ttl.max`                                | æ•´æ•°   | 86400         | ç¼“å­˜æ¡ç›®çš„æœ€å¤§ TTL (ç§’) (86400 = 1 å¤©)              |
| `dns_resolver.cache.ttl.negative`                           | æ•´æ•°   | 300           | å¦å®šå“åº” (ä¾‹å¦‚ NXDOMAIN) çš„ TTL (ç§’)                |
| `dns_resolver.cache.persistence.enabled`                    | å¸ƒå°”å€¼ | false         | æ˜¯å¦å¯ç”¨ç¼“å­˜æŒä¹…åŒ–åˆ°ç£ç›˜                            |
| `dns_resolver.cache.persistence.path`                       | å­—ç¬¦ä¸² | "./cache.dat" | ç¼“å­˜æŒä¹…åŒ–æ–‡ä»¶è·¯å¾„                                  |
| `dns_resolver.cache.persistence.load_on_startup`            | å¸ƒå°”å€¼ | true          | å¯åŠ¨æ—¶æ˜¯å¦ä»ç£ç›˜åŠ è½½ç¼“å­˜                            |
| `dns_resolver.cache.persistence.max_items_to_save`          | æ•´æ•°   | 0             | è¦ä¿å­˜çš„æœ€å¤§æ¡ç›®æ•° (0 = æ— é™åˆ¶ï¼Œå— cache.size é™åˆ¶) |
| `dns_resolver.cache.persistence.skip_expired_on_load`       | å¸ƒå°”å€¼ | true          | ä»ç£ç›˜åŠ è½½æ—¶æ˜¯å¦è·³è¿‡å·²è¿‡æœŸçš„æ¡ç›®                    |
| `dns_resolver.cache.persistence.shutdown_save_timeout_secs` | æ•´æ•°   | 30            | å…³é—­æœŸé—´ä¿å­˜ç¼“å­˜æ‰€å…è®¸çš„æœ€é•¿æ—¶é—´                    |
| `dns_resolver.cache.persistence.periodic.enabled`           | å¸ƒå°”å€¼ | false         | æ˜¯å¦å®šæœŸå°†ç¼“å­˜ä¿å­˜åˆ°ç£ç›˜                            |
| `dns_resolver.cache.persistence.periodic.interval_secs`     | æ•´æ•°   | 3600          | å®šæœŸç¼“å­˜ä¿å­˜ä¹‹é—´çš„é—´éš”æ—¶é—´ (ç§’)                     |

###### ä¸Šæ¸¸ DNS é…ç½®

| é€‰é¡¹                                         | ç±»å‹   | é»˜è®¤å€¼ | æè¿°                                                               |
| -------------------------------------------- | ------ | ------ | ------------------------------------------------------------------ |
| `dns_resolver.upstream.enable_dnssec`        | å¸ƒå°”å€¼ | false  | æ˜¯å¦å…¨å±€å¯ç”¨ DNSSEC éªŒè¯                                           |
| `dns_resolver.upstream.query_timeout`        | æ•´æ•°   | 30     | å…¨å±€ DNS æŸ¥è¯¢è¶…æ—¶æ—¶é—´ (ç§’)                                         |
| `dns_resolver.upstream.resolvers`            | æ•°ç»„   | -      | ä¸Šæ¸¸ DNS è§£æå™¨åˆ—è¡¨                                                |
| `dns_resolver.upstream.resolvers[].address`  | å­—ç¬¦ä¸² | -      | è§£æå™¨åœ°å€ (æ ¼å¼å–å†³äºåè®®)                                        |
| `dns_resolver.upstream.resolvers[].protocol` | å­—ç¬¦ä¸² | "udp"  | åè®®: "udp", "tcp", "dot" (DNS-over-TLS) æˆ– "doh" (DNS-over-HTTPS) |

###### EDNS å®¢æˆ·ç«¯å­ç½‘ (ECS) é€‰é¡¹

| é€‰é¡¹                                                       | ç±»å‹   | é»˜è®¤å€¼  | æè¿°                                            |
| ---------------------------------------------------------- | ------ | ------- | ----------------------------------------------- |
| `dns_resolver.ecs_policy.enabled`                          | å¸ƒå°”å€¼ | false   | æ˜¯å¦å¯ç”¨ ECS å¤„ç†                               |
| `dns_resolver.ecs_policy.strategy`                         | å­—ç¬¦ä¸² | "strip" | ECS å¤„ç†ç­–ç•¥: "strip", "forward" æˆ– "anonymize" |
| `dns_resolver.ecs_policy.anonymization.ipv4_prefix_length` | æ•´æ•°   | 24      | ç”¨äºåŒ¿ååŒ–çš„ IPv4 å‰ç¼€é•¿åº¦ä¿ç•™ (1-32)           |
| `dns_resolver.ecs_policy.anonymization.ipv6_prefix_length` | æ•´æ•°   | 48      | ç”¨äºåŒ¿ååŒ–çš„ IPv6 å‰ç¼€é•¿åº¦ä¿ç•™ (1-128)          |

###### DNS è·¯ç”±é€‰é¡¹

| é€‰é¡¹                                                        | ç±»å‹       | é»˜è®¤å€¼ | æè¿°                                                    |
| ----------------------------------------------------------- | ---------- | ------ | ------------------------------------------------------- |
| `dns_resolver.routing.enabled`                              | å¸ƒå°”å€¼     | false  | æ˜¯å¦å¯ç”¨ DNS è·¯ç”±                                       |
| `dns_resolver.routing.upstream_groups`                      | æ•°ç»„       | -      | ä¸Šæ¸¸ DNS æœåŠ¡å™¨ç»„åˆ—è¡¨                                   |
| `dns_resolver.routing.upstream_groups[].name`               | å­—ç¬¦ä¸²     | -      | ä¸Šæ¸¸ç»„çš„åç§°                                            |
| `dns_resolver.routing.upstream_groups[].enable_dnssec`      | å¸ƒå°”å€¼     | (ç»§æ‰¿) | æ˜¯å¦ä¸ºæ­¤ç»„å¯ç”¨ DNSSEC                                   |
| `dns_resolver.routing.upstream_groups[].query_timeout`      | æ•´æ•°       | (ç»§æ‰¿) | æ­¤ç»„çš„æŸ¥è¯¢è¶…æ—¶æ—¶é—´ (ç§’)                                 |
| `dns_resolver.routing.upstream_groups[].resolvers`          | æ•°ç»„       | -      | æ­¤ç»„ä¸­çš„è§£æå™¨åˆ—è¡¨                                      |
| `dns_resolver.routing.upstream_groups[].ecs_policy`         | å¯¹è±¡       | (ç»§æ‰¿) | æ­¤ç»„çš„ ECS ç­–ç•¥ (ä¸å…¨å±€ç»“æ„ç›¸åŒ)                        |
| `dns_resolver.routing.rules`                                | æ•°ç»„       | -      | è·¯ç”±è§„åˆ™åˆ—è¡¨                                            |
| `dns_resolver.routing.rules[].match.type`                   | å­—ç¬¦ä¸²     | -      | åŒ¹é…ç±»å‹: "exact", "regex", "wildcard", "file" æˆ– "url" |
| `dns_resolver.routing.rules[].match.values`                 | å­—ç¬¦ä¸²æ•°ç»„ | -      | ç”¨äº exact/regex/wildcard åŒ¹é…ç±»å‹çš„åŸŸå€¼åˆ—è¡¨            |
| `dns_resolver.routing.rules[].match.path`                   | å­—ç¬¦ä¸²     | -      | "file" åŒ¹é…ç±»å‹çš„æ–‡ä»¶è·¯å¾„                               |
| `dns_resolver.routing.rules[].match.url`                    | å­—ç¬¦ä¸²     | -      | "url" åŒ¹é…ç±»å‹ç”¨äºè·å–è§„åˆ™çš„ URL                        |
| `dns_resolver.routing.rules[].match.periodic.enabled`       | å¸ƒå°”å€¼     | false  | æ˜¯å¦å®šæœŸæ›´æ–° URL è§„åˆ™                                   |
| `dns_resolver.routing.rules[].match.periodic.interval_secs` | æ•´æ•°       | 3600   | æ›´æ–° URL è§„åˆ™çš„é—´éš”æ—¶é—´ (ç§’)                            |
| `dns_resolver.routing.rules[].upstream_group`               | å­—ç¬¦ä¸²     | -      | åŒ¹é…åŸŸçš„ç›®æ ‡ä¸Šæ¸¸ç»„                                      |
| `dns_resolver.routing.default_upstream_group`               | å­—ç¬¦ä¸²     | -      | æœªåŒ¹é…æŸ¥è¯¢çš„é»˜è®¤ç»„                                      |

2.  **åŸŸååˆ—è¡¨æ–‡ä»¶æ ¼å¼**

    å½“åœ¨ `config.yaml` çš„ `routing.rules` éƒ¨åˆ†ä½¿ç”¨ `file` æˆ– `url` ç±»å‹è§„åˆ™æ—¶ï¼ŒOxide WDNS æœŸæœ›å¼•ç”¨çš„æ–‡ä»¶ (æœ¬åœ°æˆ–ä» URL è·å–) éµå¾ªç‰¹å®šæ ¼å¼ï¼š

    -   **ç¼–ç ï¼š** æ–‡ä»¶å¿…é¡»æ˜¯ UTF-8 ç¼–ç ã€‚
    -   **ç»“æ„ï¼š** æ¯è¡Œä¸€ä¸ªæ¡ç›®ã€‚
    -   **æ³¨é‡Šï¼š** ä»¥ `#` å¼€å¤´çš„è¡Œè¢«è§†ä½œæ³¨é‡Šå¹¶è¢«å¿½ç•¥ã€‚
    -   **ç©ºè¡Œï¼š** ç©ºè¡Œå°†è¢«å¿½ç•¥ã€‚
    -   **é»˜è®¤åŒ¹é…ç±»å‹ï¼š** é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ä¸ªéæ³¨é‡Šã€éç©ºè¡Œéƒ½è¢«è§†ä¸ºè¦åŒ¹é…çš„**ç²¾ç¡®**åŸŸåã€‚
    -   **å…¶ä»–åŒ¹é…ç±»å‹çš„å‰ç¼€ï¼š**

        -   `regex:`: å¦‚æœä¸€è¡Œä»¥ `regex:` å¼€å¤´ï¼Œåˆ™è¯¥è¡Œä½™ä¸‹çš„éƒ¨åˆ†è¢«è§†ä¸ºç”¨äºåŒ¹é…åŸŸåçš„**æ­£åˆ™è¡¨è¾¾å¼**æ¨¡å¼ã€‚
        -   `wildcard:`: å¦‚æœä¸€è¡Œä»¥ `wildcard:` å¼€å¤´ï¼Œåˆ™è¯¥è¡Œä½™ä¸‹çš„éƒ¨åˆ†è¢«è§†ä¸º**é€šé…ç¬¦**æ¨¡å¼ (ä¾‹å¦‚ `*.example.com`ï¼Œå®ƒå¯ä»¥åŒ¹é… `www.example.com` å’Œ `example.com`)ã€‚

    **ç¤ºä¾‹æ–‡ä»¶ (`/etc/oxide-wdns/example_list.txt`):**

    ```
    # === ç¤ºä¾‹åŸŸååˆ—è¡¨ ===
    # è¿™æ˜¯ä¸€æ¡æ³¨é‡Š

    # ç²¾ç¡®åŒ¹é… (é»˜è®¤)
    google.com
    github.com

    # é€šé…ç¬¦åŒ¹é…
    wildcard:*.wikipedia.org
    wildcard:*.google.ac

    # æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…
    regex:^.*\.cn$
    regex:^ads?\..*\.com$

    # å¦ä¸€æ¡æ³¨é‡Š

    ```

    è¿™ç§æ ¼å¼å…è®¸æ‚¨åœ¨å•ä¸ªè§„åˆ™æºæ–‡ä»¶æˆ– URL ä¸­ç»„åˆä½¿ç”¨ä¸åŒçš„åŒ¹é…ç­–ç•¥ã€‚å¯¹äº `url` ç±»å‹çš„è§„åˆ™ï¼ŒOxide WDNS å°†å®šæœŸè·å–å¹¶æ ¹æ®æ­¤æ ¼å¼é‡æ–°è§£æå†…å®¹ã€‚

3.  **æµ‹è¯•é…ç½®æ–‡ä»¶ï¼š**
    åœ¨å¯åŠ¨æœåŠ¡ä¹‹å‰ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ `-t` æ ‡å¿—æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦æœ‰æ•ˆï¼š

    ```bash
    ./owdns -t -c config.yaml
    ```

4.  **å¯åŠ¨æœåŠ¡ï¼š**

    **> æ–¹æ³• 1: ç›´æ¥æ‰§è¡Œ (å‰å°)**

    æ‚¨å¯ä»¥ç›´æ¥ä»å‘½ä»¤è¡Œå¯åŠ¨ `owdns` æœåŠ¡ã€‚è¿™é€šå¸¸ç”¨äºæµ‹è¯•æˆ–ä¸´æ—¶è¿è¡Œï¼š

    ```bash
    # ä½¿ç”¨é»˜è®¤é…ç½®æ–‡ä»¶ config.yaml (å¿…é¡»åœ¨å½“å‰ç›®å½•ä¸­)
    ./owdns

    # æŒ‡å®šé…ç½®æ–‡ä»¶è·¯å¾„
    ./owdns -c /path/to/your/config.yaml

    # å¯ç”¨ Debug çº§åˆ«çš„æ—¥å¿—è®°å½•
    ./owdns -d -c config.yaml
    ```

    _æ³¨æ„: ä»¥è¿™ç§æ–¹å¼å¯åŠ¨æ—¶ï¼ŒæœåŠ¡åœ¨å‰å°è¿è¡Œã€‚å…³é—­ç»ˆç«¯çª—å£å°†ç»ˆæ­¢æœåŠ¡ã€‚_

    **> æ–¹æ³• 2: ä½¿ç”¨ systemd (åå°æœåŠ¡ï¼Œæ¨èç”¨äº Linux æœåŠ¡å™¨)**

    å¦‚æœæ‚¨å¸Œæœ› `owdns` ä½œä¸ºåå°ç³»ç»ŸæœåŠ¡è¿è¡Œå¹¶åœ¨å¯åŠ¨æ—¶è‡ªåŠ¨å¯åŠ¨ï¼Œå»ºè®®ä½¿ç”¨ `systemd`ã€‚æä¾›äº†ä¸€ä¸ªç¤ºä¾‹æœåŠ¡å•å…ƒæ–‡ä»¶ `examples/linux/systemd/owdns.service`ã€‚

    **é…ç½®æ­¥éª¤ï¼š**

    1.  **å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ï¼š**
        å°†ç¼–è¯‘åçš„ `owdns` äºŒè¿›åˆ¶æ–‡ä»¶å¤åˆ¶åˆ°ç³»ç»Ÿè·¯å¾„ï¼Œä¾‹å¦‚ `/usr/local/bin/`ï¼š

        ```bash
        sudo cp ./target/release/owdns /usr/local/bin/
        ```

    2.  **å‡†å¤‡é…ç½®æ–‡ä»¶ï¼š**
        å°†æ‚¨çš„ `config.yaml` æ–‡ä»¶æ”¾ç½®åœ¨ `systemd` æœåŠ¡æ–‡ä»¶æœŸæœ›çš„ä½ç½®ã€‚é»˜è®¤æœåŠ¡æ–‡ä»¶ (`owdns.service`) ä½¿ç”¨ `-c /etc/owdns/config.yaml`ï¼Œå› æ­¤æ‚¨éœ€è¦ï¼š

        ```bash
        # åˆ›å»ºé…ç½®ç›®å½•
        sudo mkdir -p /etc/owdns
        # å¤åˆ¶é…ç½®æ–‡ä»¶
        sudo cp config.yaml /etc/owdns/config.yaml
        ```

        _é‡è¦æç¤º: é»˜è®¤çš„ `owdns.service` ä½¿ç”¨ `DynamicUser=yes`ï¼Œè¿™æ„å‘³ç€ `systemd` ä¼šä»¥ä¸€ä¸ªä¸´æ—¶çš„ã€ä½æƒé™ç”¨æˆ· (å¦‚ `systemd-network`) è¿è¡Œ `owdns`ã€‚è¯·ç¡®ä¿è¯¥ç”¨æˆ·**å¯¹ `/etc/owdns/config.yaml` å…·æœ‰è¯»å–æƒé™**ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ `sudo chown <user>:<group> /etc/owdns/config.yaml` å’Œé€‚å½“çš„ `chmod` æƒé™è¿›è¡Œè°ƒæ•´ï¼Œæˆ–è€…ä¿®æ”¹ `owdns.service` ä¸­çš„ç”¨æˆ·/ç»„è®¾ç½®ã€‚_

    3.  **å®‰è£… systemd æœåŠ¡æ–‡ä»¶ï¼š**
        å°†ç¤ºä¾‹æœåŠ¡æ–‡ä»¶å¤åˆ¶åˆ° `systemd` ç³»ç»Ÿç›®å½•ï¼š

        ```bash
        sudo cp examples/linux/systemd/owdns.service /etc/systemd/system/
        ```

        _å¦‚æœæ‚¨ä¿®æ”¹äº†å¯æ‰§è¡Œæ–‡ä»¶æˆ–é…ç½®æ–‡ä»¶çš„è·¯å¾„ï¼Œè¯·è®°ä½ç›¸åº”åœ°ç¼–è¾‘ `/etc/systemd/system/owdns.service` ä¸­çš„ `ExecStart` è¡Œã€‚_

    4.  **é‡æ–°åŠ è½½ systemd å¹¶ç®¡ç†æœåŠ¡ï¼š**

        ```bash
        # é‡æ–°åŠ è½½ systemd é…ç½®
        sudo systemctl daemon-reload

        # å¯åŠ¨ owdns æœåŠ¡
        sudo systemctl start owdns

        # ä½¿ owdns æœåŠ¡å¼€æœºè‡ªå¯
        sudo systemctl enable owdns

        # æ£€æŸ¥æœåŠ¡çŠ¶æ€
        sudo systemctl status owdns

        # å®æ—¶æŸ¥çœ‹æœåŠ¡æ—¥å¿—
        sudo journalctl -u owdns -f

        # åœæ­¢æœåŠ¡
        # sudo systemctl stop owdns

        # ç¦æ­¢å¼€æœºè‡ªå¯
        # sudo systemctl disable owdns
        ```

    **> æ–¹æ³• 3: ä½¿ç”¨ Kubernetes éƒ¨ç½² (æ¨èç”¨äºå®¹å™¨åŒ–ç¯å¢ƒ)**

    å¦‚æœæ‚¨åœ¨ Kubernetes ç¯å¢ƒä¸­è¿è¡ŒæœåŠ¡ï¼Œ`examples/kubernetes/` ç›®å½•ä¸­æä¾›äº†ç¤ºä¾‹éƒ¨ç½²æ¸…å•ã€‚è¿™äº›é€šå¸¸åŒ…æ‹¬ï¼š

    -   `configmap.yaml`: ç®¡ç† `owdns` é…ç½®æ–‡ä»¶ (`config.yaml`)ã€‚
    -   `deployment.yaml`: å®šä¹‰ `owdns` åº”ç”¨ç¨‹åºéƒ¨ç½²ï¼ŒåŒ…æ‹¬å‰¯æœ¬æ•°ã€å®¹å™¨é•œåƒã€ç«¯å£ç­‰ã€‚
    -   `service.yaml`: åˆ›å»ºä¸€ä¸ª Kubernetes æœåŠ¡ä»¥å…¬å¼€ `owdns` æœåŠ¡ï¼Œä½¿å…¶å¯åœ¨é›†ç¾¤å†…éƒ¨æˆ–å¤–éƒ¨è®¿é—®ã€‚

    **éƒ¨ç½²æ­¥éª¤ï¼š**

    1.  **å‡†å¤‡ç¯å¢ƒï¼š** ç¡®ä¿æ‚¨æ‹¥æœ‰ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„ Kubernetes é›†ç¾¤ï¼Œå¹¶ä¸” `kubectl` å‘½ä»¤è¡Œå·¥å…·å·²é…ç½®å¹¶è¿æ¥åˆ°è¯¥é›†ç¾¤ã€‚

    2.  **è‡ªå®šä¹‰é…ç½®ï¼š**

        -   **ç¼–è¾‘ `configmap.yaml`ï¼š** æ ¹æ®æ‚¨çš„éœ€æ±‚ä¿®æ”¹ ConfigMap ä¸­çš„ `config.yaml` å†…å®¹ï¼Œç‰¹åˆ«æ˜¯ `http_server.listen_addr` (é€šå¸¸åº”ä¾¦å¬ `0.0.0.0` æˆ–ç‰¹å®šçš„ Pod IPï¼Œå¹¶æ ¹æ®éœ€è¦è®¾ç½®ç«¯å£)ã€`dns_resolver.upstream.resolvers` ç­‰ã€‚
        -   **ç¼–è¾‘ `deployment.yaml` (å¯é€‰)ï¼š** å¦‚æœæ‚¨å°†é•œåƒæ¨é€åˆ°è‡ªå·±çš„å®¹å™¨é•œåƒä»“åº“ï¼Œåˆ™å¯èƒ½éœ€è¦æ›´æ”¹å®¹å™¨é•œåƒè·¯å¾„ (`spec.template.spec.containers[0].image`)ã€‚æ‚¨è¿˜å¯ä»¥è°ƒæ•´å‰¯æœ¬æ•° (`spec.replicas`)ã€‚
        -   **ç¼–è¾‘ `service.yaml` (å¯é€‰)ï¼š** æ ¹æ®æ‚¨çš„è®¿é—®è¦æ±‚è°ƒæ•´æœåŠ¡ç±»å‹ (ä¾‹å¦‚ `ClusterIP`, `NodePort`, `LoadBalancer`) å’Œç«¯å£è®¾ç½®ã€‚

    3.  **åº”ç”¨æ¸…å•ï¼š**
        ä½¿ç”¨ `kubectl` åº”ç”¨ `examples/kubernetes/` ç›®å½•ä¸­çš„æ‰€æœ‰ YAML æ–‡ä»¶ï¼š

        ```bash
        kubectl apply -f examples/kubernetes/
        # æˆ–å•ç‹¬åº”ç”¨
        # kubectl apply -f examples/kubernetes/configmap.yaml
        # kubectl apply -f examples/kubernetes/deployment.yaml
        # kubectl apply -f examples/kubernetes/service.yaml
        ```

    4.  **éªŒè¯éƒ¨ç½²ï¼š**
        æ£€æŸ¥ Pod æ˜¯å¦æˆåŠŸè¿è¡Œä»¥åŠæœåŠ¡æ˜¯å¦å·²åˆ›å»ºï¼š

        ```bash
        # æ£€æŸ¥ Pod çŠ¶æ€ (åº”æ˜¾ç¤º Running)
        kubectl get pods -l app=owdns # å‡è®¾ Deployment/Pod å…·æœ‰ 'app=owdns' æ ‡ç­¾

        # æ£€æŸ¥æœåŠ¡ä¿¡æ¯ (è·å–è®¿é—® IP å’Œç«¯å£)
        kubectl get svc owdns-service # å‡è®¾æœåŠ¡åç§°ä¸º 'owdns-service'

        # æŸ¥çœ‹ Pod æ—¥å¿—
        kubectl logs -l app=owdns -f
        ```

    5.  **è®¿é—®æœåŠ¡ï¼š**
        æ ¹æ®æ‚¨çš„æœåŠ¡é…ç½® (ç±»å‹å’Œç«¯å£)ï¼Œæ‚¨å¯ä»¥é€šè¿‡ ClusterIP (å†…éƒ¨)ã€NodePort æˆ– LoadBalancer IP (å¤–éƒ¨) è®¿é—®å·²éƒ¨ç½²çš„ `owdns` DoH æœåŠ¡ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæœåŠ¡ç±»å‹ä¸º LoadBalancer å¹¶å…¬å¼€ç«¯å£ 80ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ `http://<LoadBalancer-IP>/dns-query` ä½œä¸º DoH ç«¯ç‚¹ã€‚

    **> æ–¹æ³• 4: ä½¿ç”¨ Docker (ç®€å•å®¹å™¨éƒ¨ç½²)**

    å¦‚æœæ‚¨æƒ³åœ¨ä¸è®¾ç½®å®Œæ•´ Kubernetes ç¯å¢ƒçš„æƒ…å†µä¸‹å¿«é€Ÿä½¿ç”¨ Docker éƒ¨ç½² `owdns`ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•ï¼š

    **éƒ¨ç½²æ­¥éª¤ï¼š**

    1. **åˆ›å»ºé…ç½®ç›®å½•ï¼š**
       åˆ›å»ºä¸€ä¸ªç›®å½•æ¥å­˜å‚¨æ‚¨çš„ `config.yaml` æ–‡ä»¶ï¼š

        ```bash
        mkdir -p ./owdns-config
        # åœ¨æ­¤ç›®å½•ä¸­åˆ›å»º/ç¼–è¾‘æ‚¨çš„ config.yaml
        nano ./owdns-config/config.yaml
        ```

    2. **æ‹‰å–å¹¶è¿è¡Œ Docker å®¹å™¨ï¼š**

        ```bash
        docker pull ghcr.io/shengyanli1982/oxide-wdns-x64:latest
        # æˆ– docker pull ghcr.io/shengyanli1982/oxide-wdns-arm64:latest

        # ä½¿ç”¨æ‚¨çš„é…ç½®æ–‡ä»¶è¿è¡Œ
        docker run -d \
          --name owdns \
          -p 3053:3053 \
          -v $(pwd)/owdns-config/config.yaml:/app/config.yaml \
          ghcr.io/shengyanli1982/oxide-wdns-x64:latest
        # æˆ– ghcr.io/shengyanli1982/oxide-wdns-arm64:latest
        ```

        æ­¤å‘½ä»¤ï¼š

        - ä»¥åˆ†ç¦»æ¨¡å¼è¿è¡Œå®¹å™¨ (`-d`)
        - å°†å…¶å‘½åä¸º "owdns" (`--name owdns`)
        - å°†å®¹å™¨çš„ 3053 ç«¯å£æ˜ å°„åˆ°æ‚¨çš„ä¸»æœº (`-p 3053:3053`)
        - å°†æ‚¨çš„é…ç½®æ–‡ä»¶æŒ‚è½½åˆ°å®¹å™¨ä¸­ (`-v`)

    3. **éªŒè¯å®¹å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œï¼š**

        ```bash
        docker ps
        # æ£€æŸ¥æ—¥å¿—
        docker logs owdns
        ```

    4. **åœ¨å®¹å™¨å†…ä½¿ç”¨ owdns-cli å®¢æˆ·ç«¯ï¼š**

        ```bash
        # ç¤ºä¾‹ï¼šä½¿ç”¨ Cloudflare çš„ DoH æœåŠ¡å™¨æŸ¥è¯¢ example.com
        docker exec owdns /app/owdns-cli https://cloudflare-dns.com/dns-query example.com

        # ä½¿ç”¨æ‚¨çš„æœ¬åœ° owdns æœåŠ¡å™¨ (å‡è®¾é»˜è®¤ç«¯å£ä¸º 3053)
        docker exec owdns /app/owdns-cli http://localhost:3053/dns-query example.com
        ```

    5. **åœæ­¢å¹¶ç§»é™¤å®¹å™¨ï¼š**

        ```bash
        docker stop owdns
        docker rm owdns
        ```

5.  **è·å–å¸®åŠ© / å‘½ä»¤è¡Œå‚æ•°ï¼š**
    ä½¿ç”¨ `-h` æˆ– `--help` æŸ¥çœ‹å®Œæ•´çš„å‘½ä»¤è¡Œå‚æ•°åˆ—è¡¨ï¼š

    ```bash
    $ ./owdns -h
    é«˜æ€§èƒ½å®‰å…¨ DNS over HTTP (DoH) ç½‘å…³

    ä¸»è¦ç‰¹æ€§:
    - å®Œå…¨ç¬¦åˆ RFC 8484 DoH æ ‡å‡† (Wireformat å’Œ JSON, GET/POST, HTTP/1.1 å’Œ HTTP/2)
    - é«˜çº§ DNSSEC éªŒè¯ï¼Œç¡®ä¿å“åº”å®Œæ•´æ€§
    - å¤šåè®®ä¸Šæ¸¸æ”¯æŒ (UDP, TCP, DoT, DoH)ï¼Œå…·æœ‰çµæ´»çš„é€‰æ‹©ç­–ç•¥
    - å¼ºå¤§çš„ DNS è·¯ç”±ï¼šåŸºäºè§„åˆ™ (ç²¾ç¡®ã€æ­£åˆ™ã€é€šé…ç¬¦ã€æ–‡ä»¶ã€URL)ï¼Œå¤šä¸ªä¸Šæ¸¸ç»„ï¼ŒåŠ è½½è¿œç¨‹è§„åˆ™
    - æ™ºèƒ½ LRU ç¼“å­˜ï¼šåŒ…æ‹¬å¦å®šç¼“å­˜å’ŒæŒä¹…åŒ–ç¼“å­˜ (ç£ç›˜åŠ è½½/ä¿å­˜ã€å®šæœŸä¿å­˜)
    - çµæ´»çš„ EDNS å®¢æˆ·ç«¯å­ç½‘ (ECS) å¤„ç†ï¼šå‰¥ç¦»ã€è½¬å‘ã€åŒ¿ååŒ–ç­–ç•¥ï¼›ECS æ„ŸçŸ¥ç¼“å­˜
    - å¼ºå¤§çš„å®‰å…¨æ€§ï¼šå†…ç½®åŸºäº IP çš„é€Ÿç‡é™åˆ¶å’Œä¸¥æ ¼çš„è¾“å…¥éªŒè¯
    - å…¨é¢çš„å¯è§‚æµ‹æ€§ï¼šé›†æˆçš„ Prometheus æŒ‡æ ‡ã€Kubernetes å¥åº·æ¢é’ˆå’Œç»“æ„åŒ–æ—¥å¿— (Tracing)
    - äº‘åŸç”Ÿå‹å¥½è®¾è®¡ï¼Œæ”¯æŒä¼˜é›…å…³é—­

    ä½œè€…: shengyanli1982
    é‚®ç®±: shengyanlee36@gmail.com
    GitHub: https://github.com/shengyanli1982

    ç”¨æ³•: owdns.exe [é€‰é¡¹]

    é€‰é¡¹:
      -c, --config <CONFIG>  æœåŠ¡å™¨é…ç½®æ–‡ä»¶è·¯å¾„ (YAML æ ¼å¼) [é»˜è®¤: config.yaml]
      -t, --test             æµ‹è¯•é…ç½®æ–‡ä»¶æœ‰æ•ˆæ€§å¹¶é€€å‡º
      -d, --debug            å¯ç”¨è°ƒè¯•çº§åˆ«æ—¥å¿—è®°å½•ä»¥è·å–è¯¦ç»†è¾“å‡º
      -h, --help             æ‰“å°å¸®åŠ©ä¿¡æ¯
      -V, --version          æ‰“å°ç‰ˆæœ¬ä¿¡æ¯
    ```

### å®¢æˆ·ç«¯ (`owdns-cli`)

å®¢æˆ·ç«¯ç”¨äºå‘ DoH æœåŠ¡å™¨å‘é€æŸ¥è¯¢ã€‚

1.  **åŸºæœ¬æŸ¥è¯¢ï¼š**
    ä»æŒ‡å®šçš„ DoH æœåŠ¡å™¨ URL æŸ¥è¯¢åŸŸåçš„ A è®°å½•ã€‚

    ```bash
    # æŸ¥è¯¢ example.com çš„ A è®°å½• (ä½¿ç”¨ Cloudflare DoH)
    ./owdns-cli https://cloudflare-dns.com/dns-query example.com

    # æŸ¥è¯¢ example.com çš„ A è®°å½• (ä½¿ç”¨æœ¬åœ° owdns æœåŠ¡ï¼Œå‡è®¾ç›‘å¬ç«¯å£ä¸º 8080)
    # æ³¨æ„ï¼šå¦‚æœæœ¬åœ°æœåŠ¡æœªé…ç½® TLSï¼Œè¯·ä½¿ç”¨ http://
    ./owdns-cli http://localhost:8080/dns-query example.com
    # å¦‚æœæœ¬åœ°æœåŠ¡ä½¿ç”¨è‡ªç­¾åè¯ä¹¦çš„ TLSï¼Œæ‚¨å¯èƒ½éœ€è¦ -k å‚æ•°
    ./owdns-cli -k https://localhost:8080/dns-query example.com
    ```

2.  **æŒ‡å®šè®°å½•ç±»å‹ (`-r` æˆ– `--record`):**

    ```bash
    # æŸ¥è¯¢ google.com çš„ MX è®°å½•
    ./owdns-cli https://dns.google/dns-query google.com -r MX
    ```

3.  **é€‰æ‹© DoH æ ¼å¼ (`--format`):**

    ```bash
    # ä½¿ç”¨ JSON æ ¼å¼æŸ¥è¯¢
    ./owdns-cli https://cloudflare-dns.com/dns-query example.com --format json
    ```

4.  **å¯ç”¨ DNSSEC (`--dnssec`):**
    è¯·æ±‚æœåŠ¡å™¨æ‰§è¡Œ DNSSEC éªŒè¯ (éœ€è¦æœåŠ¡å™¨æ”¯æŒ)ã€‚

    ```bash
    ./owdns-cli https://cloudflare-dns.com/dns-query sigfail.verteiltesysteme.net --dnssec
    ```

5.  **å¼ºåˆ¶ä½¿ç”¨ POST æ–¹æ³• (`-X POST`):**

    ```bash
    ./owdns-cli https://cloudflare-dns.com/dns-query example.com -X POST
    ```

6.  **è¯¦ç»†è¾“å‡º (`-v`, `-vv`, `-vvv`):**
    å¢åŠ  `-v` æ ‡å¿—çš„æ•°é‡ä»¥è·å–æ›´è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ (åŒ…æ‹¬ HTTP æ ‡å¤´å’Œè¯·æ±‚/å“åº”è¯¦ç»†ä¿¡æ¯)ã€‚

    ```bash
    ./owdns-cli https://cloudflare-dns.com/dns-query example.com -v
    ```

7.  **éªŒè¯å“åº” (`--validate`):**
    æ£€æŸ¥å“åº”æ˜¯å¦ç¬¦åˆç‰¹å®šæ¡ä»¶ã€‚

    ```bash
    # éªŒè¯ RCODE æ˜¯å¦ä¸º NOERROR ä¸”å“åº”åŒ…å« IP 1.1.1.1
    ./owdns-cli https://cloudflare-dns.com/dns-query one.one.one.one --validate 'rcode=NOERROR,has-ip=1.1.1.1'
    ```

8.  **è·å–å¸®åŠ© / å‘½ä»¤è¡Œå‚æ•°ï¼š**
    ä½¿ç”¨ `-h` æˆ– `--help` æŸ¥çœ‹å®Œæ•´çš„å‘½ä»¤è¡Œå‚æ•°åˆ—è¡¨ï¼š

    ```bash
    $ ./owdns-cli -h
    ä¸€ä¸ªç”¨äºå®‰å…¨ DNS over HTTP (DoH) çš„å‘½ä»¤è¡Œå®¢æˆ·ç«¯ã€‚

    ç‰¹æ€§:
    - æ”¯æŒ RFC 8484 wireformat å’Œ Google/Cloudflare JSON æ ¼å¼
    - DNSSEC éªŒè¯è¯·æ±‚
    - GET/POST æ–¹æ³•é€‰æ‹© (è‡ªåŠ¨æˆ–æ‰‹åŠ¨)
    - HTTP/1.1 å’Œ HTTP/2 æ”¯æŒ
    - å“åº”åˆ†æå’ŒéªŒè¯

    ä½œè€…: shengyanli1982
    é‚®ç®±: shengyanlee36@gmail.com
    GitHub: https://github.com/shengyanli1982

    ç”¨æ³•: owdns-cli [é€‰é¡¹] <SERVER_URL> <DOMAIN>

    å‚æ•°:
      <SERVER_URL>  DoH æœåŠ¡å™¨ç«¯ç‚¹çš„å®Œæ•´ URL (ä¾‹å¦‚ https://cloudflare-dns.com/dns-query)
      <DOMAIN>      è¦é€šè¿‡ DoH æœåŠ¡å™¨æŸ¥è¯¢çš„åŸŸå (ä¾‹å¦‚ example.com)

    é€‰é¡¹:
      -r, --record <RECORD_TYPE>  è¦æŸ¥è¯¢çš„ DNS è®°å½•ç±»å‹ (ä¾‹å¦‚ A, AAAA, MX, TXT) [é»˜è®¤: A]
          --format <FORMAT>       DoH è¯·æ±‚æ ¼å¼: 'wire' (application/dns-message) æˆ– 'json' (application/dns-json) [é»˜è®¤: wire] [å¯é€‰å€¼: wire, json]
      -X, --method <METHOD>       å¼ºåˆ¶ä½¿ç”¨ HTTP æ–¹æ³• (GET æˆ– POST)ã€‚å¦‚æœæœªæŒ‡å®šåˆ™è‡ªåŠ¨é€‰æ‹© [å¯é€‰å€¼: get, post]
          --http <HTTP_VERSION>   ç”¨äºé€šä¿¡çš„é¦–é€‰ HTTP ç‰ˆæœ¬ (1.1 æˆ– 2) [å¯é€‰å€¼: http1, http2]
          --dnssec                é€šè¿‡è®¾ç½® DNSSEC OK (DO) ä½æ¥å¯ç”¨ DNSSEC éªŒè¯
          --payload <PAYLOAD>     å‘é€åŸå§‹çš„ã€åå…­è¿›åˆ¶ç¼–ç çš„ DNS æŸ¥è¯¢è´Ÿè½½ (è¦†ç›–åŸŸå/ç±»å‹)
          --validate <VALIDATE>   æ ¹æ®é€—å·åˆ†éš”çš„æ¡ä»¶éªŒè¯å“åº” (ä¾‹å¦‚ 'rcode=NOERROR', 'has-ip=1.2.3.4')
      -k, --insecure              è·³è¿‡ TLS è¯ä¹¦éªŒè¯ (è°¨æ…ä½¿ç”¨)
      -v, --verbose...            å¢åŠ è¾“å‡ºè¯¦ç»†ç¨‹åº¦ (-v, -vv, -vvv)
          --no-color              ç¦ç”¨ç»ˆç«¯ä¸­çš„å½©è‰²è¾“å‡º
      -h, --help                  æ‰“å°å¸®åŠ©ä¿¡æ¯
      -V, --version               æ‰“å°ç‰ˆæœ¬ä¿¡æ¯
    ```

### ç¤ºä¾‹å®¢æˆ·ç«¯è„šæœ¬

æ‚¨å¯ä»¥åœ¨ `examples/client/` ç›®å½•ä¸­æ‰¾åˆ°ä½¿ç”¨ä¸åŒè¯­è¨€ (å¦‚ Pythonã€Shellã€Go ç­‰) è°ƒç”¨ DoH API çš„ç¤ºä¾‹è„šæœ¬ã€‚

## è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼è¯·ç¡®ä¿æ‚¨éµå¾ªé¡¹ç›®çš„ä»£ç è§„èŒƒã€‚

## è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ [MIT](./LICENSE) è®¸å¯è¯æˆæƒã€‚
